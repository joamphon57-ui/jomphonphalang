<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการร้านค้า (ธีมสีเขียว)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ionicons (สำหรับไอคอน) -->
    <!-- (v3.1 FIX) Reverted to v11.6.1 (Stable CDN version) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .product-sold-out { opacity: 0.6; filter: grayscale(80%); }
        #floating-cart-btn { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800"> <!-- (v3.4) GUI: Lighter BG -->

    <!-- (v3.4) GUI: Changed to Emerald -->
    <header class="bg-emerald-700 text-white shadow-md sticky top-0 z-20">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <ion-icon name="storefront-outline" class="text-3xl"></ion-icon>
                <h1 class="text-2xl font-bold">JomphonShop</h1>
            </div>
            <div class="flex space-x-3 items-center">
                <button id="show-store-btn" class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-semibold hover:bg-gray-100 transition shadow flex items-center">
                    <ion-icon name="cart-outline" class="mr-1"></ion-icon> หน้าร้านค้า
                </button>
                <button id="show-admin-btn" class="px-4 py-2 bg-emerald-800 text-white rounded-lg font-semibold hover:bg-emerald-900 transition shadow flex items-center hidden">
                    <ion-icon name="settings-outline" class="mr-1"></ion-icon> แอดมิน
                </button>
                
                <button id="admin-login-btn" class="p-2 bg-white text-emerald-700 rounded-full font-semibold hover:bg-gray-100 transition shadow">
                    <ion-icon name="person-circle-outline" class="text-2xl block align-middle"></ion-icon>
                </button>
                <button id="admin-logout-btn" class="p-2 bg-emerald-800 text-white rounded-full font-semibold hover:bg-emerald-900 transition shadow hidden">
                    <ion-icon name="log-out-outline" class="text-2xl block align-middle"></ion-icon>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 lg:p-8">

        <!-- Firebase Info -->
        <div class="mb-4 p-3 bg-emerald-100 border border-emerald-300 rounded-lg text-xs text-emerald-800">
            <p><strong>App ID:</strong> <span id="app-id-display">...</span> | <strong>User ID:</strong> <span id="user-id-display">...</span> | <strong>Status:</strong> <span id="auth-status">...</span></p>
        </div>

        <!-- ========================= ADMIN SECTION ========================= -->
        <section id="admin-section" class="hidden">
            <h2 class="text-3xl font-bold text-emerald-800 mb-6">หน้าแอดมิน (Admin)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- LEFT COLUMN: Manage Products -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- (v3.6) REMOVED Manual Sale (Quick Sale) -->

                    <!-- (v3.9) Manage Categories -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="file-tray-stacked-outline" class="mr-2 text-2xl"></ion-icon>
                            จัดการหมวดหมู่
                        </h3>
                        <form id="add-category-form" class="p-6 space-y-4 mb-0">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-grow">
                                    <label class="block text-sm font-medium text-gray-700">ชื่อหมวดหมู่ใหม่</label>
                                    <input type="text" id="category-name" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="เช่น เครื่องดื่ม, ขนม" required>
                                </div>
                                <div class="flex-shrink-0 flex items-end">
                                    <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">เพิ่ม</button>
                                </div>
                            </div>
                            <!-- (v3.9) New Checkbox -->
                            <div class="mt-2">
                                <input type="checkbox" id="category-track-stock" class="rounded text-emerald-600 focus:ring-emerald-500" checked>
                                <label for="category-track-stock" class="ml-2 text-sm text-gray-700">ติดตามสต็อก (นับจำนวน)</label>
                            </div>
                        </form>
                        <div id="category-list" class="p-6 pt-4 space-y-2"></div>
                    </div>

                    <!-- Add/Edit Product -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                         <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="add-circle-outline" class="mr-2 text-2xl"></ion-icon>
                            เพิ่ม / แก้ไขสินค้า
                        </h3>
                        <form id="add-product-form" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">เลือกหมวดหมู่</label>
                                <select id="product-category" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                    <option value="">-- กรุณาเลือกหมวดหมู่ --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ชื่อสินค้า</label>
                                <input type="text" id="product-name" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <!-- Image Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">รูปภาพสินค้า</label>
                                <input type="file" id="product-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                                <div id="image-preview-container" class="mt-2 hidden">
                                    <img id="image-preview" src="" class="w-32 h-32 object-cover rounded border">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ราคา (1 ชิ้น)</label>
                                <input type="number" id="product-price" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <!-- Dropdown เลือกประเภทโปรโมชั่น -->
                            <div>
                                <label for="product-promo-type" class="block text-sm font-medium text-gray-700">ประเภทโปรโมชั่น</label>
                                <select id="product-promo-type" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                    <option value="BIG_BOTTLE">โปรขวดใหญ่: 2@150, 4@240 (น้ำปกติ)</option>
                                    <option value="SMALL_BOTTLE">โปรขวดเล็ก: 3@100</option>
                                    <option value="EXCLUDED">ราคาคงที่ (ไม่เข้าร่วมโปรเหมา เช่น น้ำดิบ)</option>
                                </select>
                            </div>
                            <input type="hidden" id="product-id">
                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">ยกเลิก</button>
                                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">
                                    <span id="submit-product-btn-text">เพิ่มสินค้าใหม่</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Product List -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="list-outline" class="mr-2 text-2xl"></ion-icon>
                            รายการสินค้า
                        </h3>
                        <div class="p-6">
                            <input type="text" id="admin-search-bar" placeholder="ค้นหา..." class="w-full px-3 py-2 border rounded-md mb-4">
                            <div id="admin-product-list" class="space-y-4 max-h-[500px] overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Sidebar -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- INCOMING ORDERS -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-bold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between">
                            <div class="flex items-center">
                                <ion-icon name="notifications-outline" class="mr-2 text-2xl"></ion-icon> ออเดอร์เข้าใหม่
                            </div>
                            <span id="pending-order-count" class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
                        </h3>
                        <div id="order-list" class="p-6 space-y-3 max-h-[400px] overflow-y-auto pr-1">
                            <p class="text-gray-500 text-center py-4">ยังไม่มีออเดอร์</p>
                        </div>
                    </div>

                    <!-- Z-Report -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="analytics-outline" class="mr-2 text-2xl"></ion-icon>
                            ยอดปัจจุบัน (รอตัดยอด)
                        </h3>
                        <div class="p-6 space-y-2 text-lg">
                            <div class="flex justify-between"><span>ยอดขาย:</span> <span id="sales-tally-total" class="font-bold text-green-700">0.00 บาท</span></div>
                            <div class="flex justify-between"><span>รายจ่าย:</span> <span id="expense-tally-total" class="font-bold text-red-600">0.00 บาท</span></div>
                        </div>
                        <div class="p-6 pt-0">
                            <button id="z-report-button" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">ตัดยอดรายวัน</button>
                        </div>
                    </div>

                    <!-- Z-Report History -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between">
                            <div class="flex items-center">
                                <ion-icon name="archive-outline" class="mr-2 text-2xl"></ion-icon> ประวัติการตัดยอด
                            </div>
                            <button id="show-clear-history-modal" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 font-semibold shadow">
                                ล้าง...
                            </button>
                        </h3>
                        <div id="z-report-history-list" class="p-6 space-y-2 max-h-[200px] overflow-y-auto text-sm"></div>
                    </div>

                    <!-- Stock Log History -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="receipt-outline" class="mr-2 text-2xl"></ion-icon>
                            ประวัติการเติมสต็อก
                        </h3>
                        <div id="stock-history-list" class="p-6 space-y-2 max-h-[200px] overflow-y-auto text-sm">
                            <p class="text-gray-500">ยังไม่มีประวัติการเติม</p>
                        </div>
                    </div>

                    <!-- Expense -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="wallet-outline" class="mr-2 text-2xl"></ion-icon>
                            บันทึกรายจ่าย
                        </h3>
                        <form id="add-expense-form" class="p-6 space-y-3">
                            <input type="hidden" id="expense-id">
                            <input type="text" id="expense-description" class="w-full px-3 py-2 border rounded-md" placeholder="รายการ (เช่น ค่าไฟ)" required>
                            <input type="number" id="expense-amount" class="w-full px-3 py-2 border rounded-md" placeholder="จำนวนเงิน" required>
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold shadow">
                                    <span id="submit-expense-btn-text">บันทึก</span>
                                </button>
                                <button type="button" id="cancel-expense-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">ยกเลิก</button>
                            </div>
                        </form>
                        <div id="expense-history-list" class="p-6 pt-2 space-y-2 max-h-[200px] overflow-y-auto text-sm border-t"></div>
                    </div>

                    <!-- (v3.9) MODIFIED: Eating Log -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="fast-food-outline" class="mr-2 text-2xl"></ion-icon>
                            บันทึกการกิน (ตัดสต็อก)
                        </h3>
                        <form id="add-eating-log-form" class="p-6 space-y-3">
                            <input type="hidden" id="eat-log-id"> <!-- (v3.9) New -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">เลือกหมวดหมู่ที่กิน</label>
                                <select id="eat-category-select" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                    <option value="">-- เลือกหมวดหมู่ --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">จำนวน (ชิ้น)</label>
                                    <input type="number" id="eat-quantity" class="w-full px-3 py-2 border rounded-md" placeholder="1" required min="1" value="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ชื่อคนกิน</label>
                                    <input type="text" id="eat-person" class="w-full px-3 py-2 border rounded-md" placeholder="ชื่อ..." required>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold shadow">
                                    <span id="submit-eat-log-btn-text">บันทึก</span>
                                </button>
                                <button type="button" id="cancel-eat-log-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">ยกเลิก</button>
                            </div>
                        </form>
                        <div id="eating-log-history-list" class="p-6 pt-2 space-y-2 max-h-[200px] overflow-y-auto text-sm border-t">
                            <p class="text-gray-500">ยังไม่มีประวัติการกิน</p>
                        </div>
                    </div>
                    
                </div>
            </div>
        </section>

        <!-- ========================= CUSTOMER SECTION ========================= -->
        <section id="store-section">
             <!-- (v3.4) GUI: Added Gradient to active tab -->
            <h2 class="text-3xl font-bold text-emerald-800 mb-6">หน้าร้านค้า</h2>
            <div id="category-tabs" class="flex overflow-x-auto whitespace-nowrap space-x-3 mb-6 p-1 bg-gray-200 rounded-lg shadow-inner no-scrollbar sticky top-[88px] z-10">
                <!-- Tabs will be rendered here -->
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                <div class="lg:col-span-1">
                    <div class="mb-4">
                        <input type="text" id="customer-search-bar" placeholder="ค้นหาสินค้า..." class="w-full px-4 py-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <!-- Product List (Grid) -->
                    <div id="customer-product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Floating Cart Button -->
    <button id="floating-cart-btn" class="bg-red-600 text-white p-4 rounded-full shadow-2xl hover:bg-red-700 transition transform hover:scale-105 relative" onclick="document.getElementById('cart-modal').classList.remove('hidden')">
        <ion-icon name="cart-outline" class="text-2xl"></ion-icon>
        <span id="cart-item-count" class="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4 bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ring-2 ring-white hidden">0</span>
    </button>

    <!-- ========================= MODALS ========================= -->

    <!-- (v3.1) Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-semibold text-gray-800">ล็อกอินแอดมิน</h3>
                <button id="admin-login-modal-close" class="text-gray-500 hover:text-gray-700">
                    <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                </button>
            </div>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="admin-email" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                </div>
                <button type="submit" class="w-full px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">
                    ล็อกอิน
                </button>
            </form>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 pb-4 border-b">
                <h3 class="text-xl font-semibold text-gray-800">ตะกร้าสินค้า</h3>
                <button onclick="document.getElementById('cart-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div id="cart-items" class="p-6 space-y-3 overflow-y-auto no-scrollbar">
                <!-- Cart items go here -->
            </div>
            <p id="cart-empty-msg" class="text-center text-gray-500 p-6">ตะกร้าว่างเปล่า</p>
            <div class="p-6 border-t mt-auto space-y-4 bg-gray-50 rounded-b-xl">
                <div class="flex justify-between text-xl font-bold">
                    <span>ยอดรวม:</span> 
                    <span id="cart-total" class="text-emerald-700">0.00 บาท</span>
                </div>
                <form id="checkout-form">
                    <button id="checkout-button" type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow-lg" disabled>
                        สั่งซื้อ (Checkout)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Global Modals (Other Modals) -->
    <div id="global-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 text-center">
            <p id="global-modal-message" class="text-lg text-gray-800 mb-6"></p>
            <button id="global-modal-close" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">ตกลง</button>
        </div>
    </div>
    <div id="update-stock-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 overflow-hidden">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">อัปเดตสต็อก: <span id="update-stock-category-name" class="ml-2"></span></h3>
            <form id="update-stock-form" class="p-6 space-y-4">
                <input type="hidden" id="update-stock-category-id">
                <input type="number" id="stock-adjustment" placeholder="+ เพิ่ม หรือ - ลด" class="w-full px-3 py-2 border rounded-md" required>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="update-stock-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">ยืนยัน</button>
                </div>
            </form>
        </div>
    </div>
    <div id="z-report-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                <ion-icon name="document-text-outline" class="mr-2 text-2xl"></ion-icon> สรุปยอด (Z-Report)
            </h3>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div><h4 class="text-green-700 font-bold">1. รายรับ</h4><div id="z-report-sales-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-green-200"></div></div>
                <div><h4 class="text-red-700 font-bold">2. รายจ่าย</h4><div id="z-report-expense-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-red-200"></div></div>
                <div><h4 class="text-blue-700 font-bold">3. สต็อกคงเหลือ</h4><div id="z-report-stock-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-blue-200"></div></div>
                <div><h4 class="text-yellow-700 font-bold">4. ประวัติการเติมสต็อก (รอบนี้)</h4><div id="z-report-stock-refill-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-yellow-200"></div></div>
                <!-- (v3.7) New: Eating Log Summary -->
                <div><h4 class="text-orange-700 font-bold">5. ประวัติการกิน (รอบนี้)</h4><div id="z-report-eating-log-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-orange-200"></div></div>
            </div>
            <div class="p-6 border-t mt-auto space-y-1 font-bold bg-gray-50 rounded-b-xl">
                <div class="flex justify-between text-green-700"><span>ยอดขาย:</span><span id="z-report-total-sales">0.00</span></div>
                <div class="flex justify-between text-red-700"><span>รายจ่าย:</span><span id="z-report-total-expense">0.00</span></div>
                <div class="flex justify-between text-blue-800 border-t mt-2 pt-2 text-lg"><span>กำไรสุทธิ:</span><span id="z-report-net-profit">0.00</span></div>
            </div>
            <div class="flex justify-end space-x-3 p-6 pt-4 bg-gray-50">
                <button id="z-report-cancel-button" class="px-4 py-2 bg-gray-200 rounded-lg">ยกเลิก</button>
                <button id="z-report-confirm-button" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">ยืนยันตัดยอด</button>
            </div>
        </div>
    </div>
    <div id="history-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                <ion-icon name="archive-outline" class="mr-2 text-2xl"></ion-icon> รายละเอียดประวัติ
            </h3>
            <div id="history-detail-content" class="p-6 space-y-4 overflow-y-auto"></div>
            <div class="flex justify-end mt-auto p-6 border-t bg-gray-50 rounded-b-xl">
                <button id="history-detail-close-btn" class="px-4 py-2 bg-gray-200 rounded-lg">ปิด</button>
            </div>
        </div>
    </div>

    <!-- (v3.3) Confirm Clear History Modal -->
    <div id="confirm-clear-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 text-center">
            <h3 class="text-xl font-semibold text-red-700 mb-4">ยืนยันการล้างประวัติ</h3>
            <p id="confirm-clear-message" class="text-lg text-gray-800 mb-6">คุณแน่ใจหรือไม่ว่าต้องการล้างประวัติ (ตัดยอด, เติมสต็อก, รายจ่ายที่เคลียร์แล้ว, ประวัติการกิน)?<br><strong class="text-red-600">การกระทำนี้ "ไม่สามารถย้อนกลับได้"</strong></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-clear-cancel" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="confirm-clear-confirm" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">ยืนยันการล้าง</button>
            </div>
        </div>
    </div>


    <!-- Logic -->
    <script type="module">
        // (v3.1 FIX) Reverted to v11.6.1 (Stable CDN version)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithEmailAndPassword, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            orderBy, 
            addDoc, 
            writeBatch, 
            serverTimestamp, 
            increment, 
            runTransaction, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // (v3.1 FIX) Removed analytics (was part of v12 snippet)

        // (v3.1) นี่คือ Config (กุญแจ) ใหม่ของคุณ
        const firebaseConfig = {
            apiKey: "AIzaSyBcIa3RBMd1-kt9tOO6tdUDXbRrz0lLWl8",
            authDomain: "jomphonshop.firebaseapp.com",
            projectId: "jomphonshop",
            storageBucket: "jomphonshop.firebasestorage.app",
            messagingSenderId: "479449480163",
            appId: "1:479449480163:web:a0179b60c6983ef9437ed6",
            measurementId: "G-XH44BT8W7B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(app); // (v3.1 FIX) Removed analytics

        let db, auth, userId, currentImageBase64 = "";
        let localProducts = [], localOrders = [], localCategories = [], localExpenses = [], localReportHistory = [], cart = [];
        let localStockHistory = []; // (v3.2) New
        let localEatingHistory = []; // (v3.7) New
        let activeCategoryFilter = 'ALL'; 
        let listenersInitialized = false; 

        // --- Promotion Rule Sets (v2.9) ---
        const PROMO_RULE_SETS = {
            'EXCLUDED': null, 
            'BIG_BOTTLE': [{ quantity: 4, price: 240 }, { quantity: 2, price: 150 }, { quantity: 1, price: 80 }],
            'SMALL_BOTTLE': [{ quantity: 3, price: 100 }, { quantity: 1, price: 40 }]
        };

        // UI Elements
        const showModal = (msg) => { document.getElementById('global-modal-message').textContent = msg; document.getElementById('global-modal').classList.remove('hidden'); };
        document.getElementById('global-modal-close').onclick = () => document.getElementById('global-modal').classList.add('hidden');
        
        const storeSection = document.getElementById('store-section');
        const adminSection = document.getElementById('admin-section');
        const showStoreBtn = document.getElementById('show-store-btn');
        const showAdminBtn = document.getElementById('show-admin-btn');
        const appId = "jomphonshop"; // (v3.1) Hardcode based on config
        const stockHistoryList = document.getElementById('stock-history-list'); // (v3.2) New
        const confirmClearModal = document.getElementById('confirm-clear-modal'); // (v3.3) New
        
        // (v3.9) Modified Eating Log UI
        const addEatingLogForm = document.getElementById('add-eating-log-form');
        const eatCategorySelect = document.getElementById('eat-category-select'); // (v3.9) Changed
        const eatingLogHistoryList = document.getElementById('eating-log-history-list');
        const eatLogIdInput = document.getElementById('eat-log-id');
        const cancelEatLogBtn = document.getElementById('cancel-eat-log-btn');
        const submitEatLogBtnText = document.getElementById('submit-eat-log-btn-text');

        // Image Compression
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 400 / img.width;
                        canvas.width = 400; canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.onerror = reject;
            });
        }
        document.getElementById('product-image-file').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                try { 
                    currentImageBase64 = await compressImage(e.target.files[0]); 
                    document.getElementById('image-preview').src = currentImageBase64; 
                    document.getElementById('image-preview-container').classList.remove('hidden'); 
                } 
                catch(err) { showModal("อ่านรูปไม่ได้"); }
            }
        });

        // Listeners & Renderers
        // (v3.9) Modified
        function renderCategories() {
            const list = document.getElementById('category-list');
            const select = document.getElementById('product-category');
            const tabsContainer = document.getElementById('category-tabs');
            const eatCategorySelect = document.getElementById('eat-category-select'); // (v3.9) New
            
            list.innerHTML = ''; 
            select.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
            tabsContainer.innerHTML = '';
            eatCategorySelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>'; // (v3.9) New

            // 1. Render 'All' Tab first
            const allTabClass = activeCategoryFilter === 'ALL' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-100';
            tabsContainer.innerHTML += `
                <button onclick="window.setCategoryFilter('ALL')" class="px-4 py-2 rounded-lg font-semibold transition ${allTabClass}">ทั้งหมด</button>
            `;

            localCategories.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                // Populate dropdowns
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                eatCategorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; // (v3.9) New

                // (v3.9) New: Check if stock is tracked
                const stockDisplay = c.isStockTracked 
                    ? `(<span class="font-bold ${c.remainingStock <= 5 ? 'text-red-600' : 'text-gray-800'}">${c.remainingStock}</span> / ${c.totalStock} ชิ้น)`
                    : `(<span class="text-blue-600">ไม่นับสต็อก</span>)`;
                
                const stockButton = c.isStockTracked
                    ? `<button onclick="window.openStock('${c.id}','${c.name}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">สต็อก</button>`
                    : ''; // Hide stock button if not tracked

                // Render admin list
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                        <div>
                            <span class="font-bold text-emerald-800">${c.name}</span>
                            <p class="text-sm text-gray-600">คงเหลือ: ${stockDisplay}</p>
                        </div>
                        ${stockButton}
                    </div>`;

                // Render Category Tabs
                const tabClass = activeCategoryFilter === c.id ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-100';
                tabsContainer.innerHTML += `
                    <button onclick="window.setCategoryFilter('${c.id}')" class="px-4 py-2 rounded-lg font-semibold transition ${tabClass}">${c.name}</button>
                `;
            });
        }
        window.setCategoryFilter = (categoryId) => {
            activeCategoryFilter = categoryId;
            renderCategories(); // Rerender to highlight the active tab
            renderProducts();   // Rerender products with the new filter
        };

        // (v3.9) Modified
        function renderProducts() {
            const adminList = document.getElementById('admin-product-list');
            const custList = document.getElementById('customer-product-list');
            const adminSearch = document.getElementById('admin-search-bar').value.toLowerCase();
            const custSearch = document.getElementById('customer-search-bar').value.toLowerCase();
            
            // (v3.9) REMOVED: No longer need to populate eat-product-select
            // eatProductSelect.innerHTML = '<option value="">-- เลือกสินค้า --</option>';

            adminList.innerHTML = ''; custList.innerHTML = '';
            
            localProducts.forEach(p => {
                const cat = localCategories.find(c => c.id === p.categoryId);
                
                // (v3.9) Modified Sold Out Logic
                let isSoldOut = p.isOutOfStock; // Default (manual toggle)
                if (cat && cat.isStockTracked && cat.remainingStock <= 0) {
                    isSoldOut = true; // Sold out if tracked and empty
                }
                if (cat && !cat.isStockTracked) {
                    isSoldOut = false; // NEVER sold out if not tracked
                }
                
                const img = p.imageUrl || `https://placehold.co/400x300/eee/999?text=${encodeURIComponent(p.name)}`;
                
                const promoText = p.promoType === 'EXCLUDED' ? 'ราคาคงที่' : 
                                  p.promoType === 'BIG_BOTTLE' ? 'โปรขวดใหญ่' : 
                                  p.promoType === 'SMALL_BOTTLE' ? 'โปรขวดเล็ก' : 'N/A';
                
                // (v3.9) REMOVED: Populate Eating Log

                // Admin View
                if(p.name.toLowerCase().includes(adminSearch)) {
                    adminList.innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center gap-3">
                                <img src="${img}" class="w-12 h-12 object-cover rounded border">
                                <div><div class="font-bold text-sm">${p.name}</div><div class="text-xs text-gray-500">${p.basePrice} บ. | ${cat?.name||'-'} (${promoText})</div></div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="window.toggleStock('${p.id}',${p.isOutOfStock})" class="text-xs px-2 py-1 rounded text-white ${p.isOutOfStock?'bg-gray-500':'bg-green-500'}">${p.isOutOfStock?'ปิด':'เปิด'}</button>
                                <button onclick="window.editProd('${p.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded">แก้</button>
                                <button onclick="window.delProd('${p.id}')" class="text-xs px-2 py-1 bg-red-600 text-white rounded">ลบ</button>
                            </div>
                        </div>`;
                }

                // Customer View (v3.0 filter)
                const passesCategoryFilter = activeCategoryFilter === 'ALL' || p.categoryId === activeCategoryFilter;

                if(p.name.toLowerCase().includes(custSearch) && passesCategoryFilter) {
                    let promoDetail = '';
                    let promoColor = 'bg-red-600';
                    if(p.promoType === 'BIG_BOTTLE') { promoDetail = '2ชิ้น 150 | 4ชิ้น 240'; promoColor = 'bg-red-600'; }
                    else if(p.promoType === 'SMALL_BOTTLE') { promoDetail = '3ชิ้น 100 บาท!'; promoColor = 'bg-pink-600'; }
                    else if(p.promoType === 'EXCLUDED') { promoDetail = 'สินค้าราคาต่อชิ้น'; promoColor = 'bg-yellow-600'; }

                    custList.innerHTML += `
                        <div class="bg-white rounded-xl shadow border overflow-hidden flex flex-col justify-between ${isSoldOut ? 'product-sold-out' : 'hover:shadow-md'}">
                            <div class="relative">
                                <!-- (v3.8) MODIFIED: Changed to aspect-square -->
                                <img src="${img}" class="w-full aspect-square object-cover" onerror="this.src='https://placehold.co/400x300/eee/999?text=Error'">
                                ${isSoldOut ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">หมด</div>' : ''}
                                <div class="absolute top-2 left-2 text-white text-[10px] font-bold px-2 py-1 rounded ${promoColor}">${promoText}</div>
                            </div>
                            <div class="p-3 flex flex-col flex-grow">
                                <h4 class="font-bold truncate">${p.name}</h4>
                                <p class="text-sm text-gray-500">${p.basePrice} บ.</p>
                                <div class="text-xs text-emerald-700 my-2">${promoDetail}</div>
                                <div class="mt-auto">
                                    <button onclick="window.addCart('${p.id}')" class="w-full py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded text-sm" ${isSoldOut?'disabled':''}>${isSoldOut?'หมด':'ใส่ตะกร้า'}</button>
                                </div>
                            </div>
                        </div>`;
                }
            });
        }

        // --- Helper Function to apply specific rules ---
        function applyPromoRules(quantity, rules) {
// ... (existing code, no change) ...
        }

        // (v2.9 Logic) Pricing Logic:
        function calculateFinalPrice(cartItems) {
// ... (existing code, no change) ...
        }


        function renderCart() {
// ... (existing code, no change) ...
        }

        // Global Actions
        window.openStock = (id, name) => { document.getElementById('update-stock-category-id').value = id; document.getElementById('update-stock-category-name').textContent = name; document.getElementById('update-stock-modal').classList.remove('hidden'); };
        document.getElementById('update-stock-cancel').onclick = () => document.getElementById('update-stock-modal').classList.add('hidden');
        
        // (v3.2) Modified Stock Update Form
        document.getElementById('update-stock-form').onsubmit = async (e) => {
// ... (existing code, no change) ...
        };

        window.toggleStock = async (id, state) => await updateDoc(doc(db, `artifacts/${appId}/public/data/products`, id), { isOutOfStock: !state });
        window.delProd = async (id) => confirm('ลบ?') && await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, id));
        window.editProd = (id) => {
// ... (existing code, no change) ...
        };
        document.getElementById('cancel-edit-btn').onclick = () => { 
// ... (existing code, no change) ...
        };

        // (v3.9) Modified addCart
        window.addCart = (id) => { 
            const product = localProducts.find(p => p.id === id);
            const category = localCategories.find(c => c.id === product.categoryId);
            
            // (v3.9) Modified check: Only check stock if category is tracked
            let isSoldOut = product.isOutOfStock;
            if (category && category.isStockTracked && category.remainingStock <= 0) {
                isSoldOut = true;
            }
            
            if(isSoldOut) { 
                showModal('ของหมด'); 
                return; 
            }
            
            const item = cart.find(c => c.id === id); 
            if(item) item.quantity++; else cart.push({id, quantity:1}); 
            renderCart(); 
            showModal('เพิ่มลงตะกร้าแล้ว'); 
        };
        window.modCart = (id, val) => {
// ... (existing code, no change) ...
        };

        // (v3.9) Modified Order Actions (pay function)
        window.pay = async (id) => {
            const o = localOrders.find(x => x.id === id);
            if(!o) return;
            try {
                await runTransaction(db, async (t) => {
                    t.update(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: 'paid' });
                    
                    // Create map of {categoryId: quantity}
                    const map = new Map();
                    o.items.forEach(i => { 
                        const p = localProducts.find(x=>x.id===i.id); 
                        if(p && p.categoryId) map.set(p.categoryId, (map.get(p.categoryId)||0)+i.quantity); 
                    });
                    
                    // (v3.9) Loop map and deduct stock ONLY if category is tracked
                    map.forEach((qty, catId) => {
                        const category = localCategories.find(c => c.id === catId);
                        if (category && category.isStockTracked) { // Only deduct if tracked
                            t.update(doc(db, `artifacts/${appId}/public/data/categories`, catId), { remainingStock: increment(-qty) });
                        }
                    });
                });
            } catch(err) { showModal('Error'); }
        };
        window.cancel = async (id) => await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: 'cancelled' });
        window.delOrder = async (id) => await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: 'deleted' }); 

        // Forms
        // (v3.9) Modified add-category-form
        document.getElementById('add-category-form').onsubmit = async (e) => {
            e.preventDefault();
            const categoryName = document.getElementById('category-name').value;
            const isTracked = document.getElementById('category-track-stock').checked; // (v3.9) New
            
            await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), { 
                name: categoryName, 
                totalStock: 0, 
                remainingStock: 0,
                isStockTracked: isTracked // (v3.9) New
            }); 
            e.target.reset();
            document.getElementById('category-track-stock').checked = true; // (v3.9) Reset checkbox
        };
        document.getElementById('add-product-form').onsubmit = async (e) => {
// ... (existing code, no change) ...
        };
        
        // (v3.9) Modified: Eating Log Form
        addEatingLogForm.onsubmit = async (e) => {
            e.preventDefault();
            const categoryId = document.getElementById('eat-category-select').value;
            const quantity = parseInt(document.getElementById('eat-quantity').value);
            const person = document.getElementById('eat-person').value;
            const logId = eatLogIdInput.value; // (v3.9) Get ID for editing

            if (!categoryId || isNaN(quantity) || quantity <= 0 || !person) {
                showModal("ข้อมูลไม่ครบถ้วน (ต้องเลือกหมวดหมู่, จำนวน, และชื่อคนกิน)");
                return;
            }

            const category = localCategories.find(c => c.id === categoryId);
            if (!category) {
                showModal("ไม่พบหมวดหมู่");
                return;
            }

            // (v3.9) Only check stock if the category is tracked
            if (category.isStockTracked && category.remainingStock < quantity) {
                showModal(`สต็อกไม่พอ! (${category.name} เหลือ ${category.remainingStock})`);
                return;
            }

            const logData = {
                categoryId: categoryId,
                categoryName: category.name,
                quantity: quantity,
                personName: person,
                // No product info
            };

            try {
                if (logId) {
                    // This is an UPDATE
                    // Note: We DO NOT adjust stock on edit, only on creation. Admin must fix stock manually.
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/eatingHistory`, logId), logData);
                    showModal("แก้ไขบันทึกการกินสำเร็จ!");

                } else {
                    // This is a NEW entry
                    logData.createdAt = serverTimestamp();
                    const batch = writeBatch(db);
                    
                    // 1. Log the eating event
                    batch.set(doc(collection(db, `artifacts/${appId}/public/data/eatingHistory`)), logData);
                    
                    // 2. Deduct stock ONLY if tracked
                    if (category.isStockTracked) {
                        const stockRef = doc(db, `artifacts/${appId}/public/data/categories`, category.id);
                        batch.update(stockRef, { remainingStock: increment(-quantity) });
                    }
                    
                    await batch.commit();
                    showModal(`บันทึกการกิน (${category.name} ${quantity} ชิ้น) และตัดสต็อกสำเร็จ!`);
                }
                
                cancelEatLogBtn.click(); // Reset form

            } catch (err) {
                console.error("Error logging eating event: ", err);
                showModal("เกิดข้อผิดพลาด: " + err.message);
            }
        };

        // (v3.9) New: Edit/Delete/Cancel Eating Log
        window.editEatLog = (id) => {
            const log = localEatingHistory.find(x => x.id === id);
            eatLogIdInput.value = log.id;
            document.getElementById('eat-category-select').value = log.categoryId;
            document.getElementById('eat-quantity').value = log.quantity;
            document.getElementById('eat-person').value = log.personName;
            cancelEatLogBtn.classList.remove('hidden');
            submitEatLogBtnText.textContent = "แก้ไข";
        };

        window.delEatLog = async (id) => {
            // Note: Does not refund stock.
            if (confirm('ลบ? (การลบนี้จะไม่คืนสต็อกที่ตัดไปแล้ว)')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/eatingHistory`, id));
                    showModal("ลบประวัติการกินแล้ว");
                } catch (err) {
                    showModal("เกิดข้อผิดพลาด: " + err.message);
                }
            }
        };

        cancelEatLogBtn.onclick = () => {
            addEatingLogForm.reset();
            eatLogIdInput.value = '';
            cancelEatLogBtn.classList.add('hidden');
            submitEatLogBtnText.textContent = "บันทึก";
            document.getElementById('eat-quantity').value = 1; // Reset default
        };


        // (v3.9) Modified: Render Eating Log History (Simplified)
        function renderEatingLogHistory() {
            eatingLogHistoryList.innerHTML = '';
            if (localEatingHistory.length === 0) {
                eatingLogHistoryList.innerHTML = '<p class="text-gray-500">ยังไม่มีประวัติการกิน</p>';
                return;
            }
            localEatingHistory.forEach(log => {
                // (v3.9) Removed timestamp
                // const time = log.createdAt?.toDate ? log.createdAt.toDate().toLocaleString('th-TH') : '...';
                eatingLogHistoryList.innerHTML += `
                    <div class="flex justify-between items-center text-xs p-1 border-b">
                        <span>${log.personName} กิน ${log.categoryName} (<span class="text-red-600 font-bold">-${log.quantity}</span>)</span>
                        <div class="flex gap-2">
                            <button onclick="window.editEatLog('${log.id}')" class="text-blue-500">✎</button>
                            <button onclick="window.delEatLog('${log.id}')" class="text-red-500">x</button>
                        </div>
                    </div>`;
            });
        }


        // Expense & Report
        document.getElementById('add-expense-form').onsubmit = async (e) => {
// ... (existing code, no change) ...
        };
        window.editExp = (id) => { 
// ... (existing code, no change) ...
        };
        window.delExp = (id) => confirm('ลบ?') && deleteDoc(doc(db, `artifacts/${appId}/public/data/expenses`, id));
        document.getElementById('cancel-expense-btn').onclick = () => { 
// ... (existing code, no change) ...
        };
        
        // (v3.2) New: Render Stock History
        function renderStockHistory() {
// ... (existing code, no change) ...
        }
        
        // (v3.1) *** FIX: This is the one and only renderStats function ***
        function renderStats() {
// ... (existing code, no change) ...
        }

        // (v3.7) Modified Z-Report Button
        document.getElementById('z-report-button').onclick = () => {
// ... (existing code, no change) ...
        };
        document.getElementById('z-report-cancel-button').onclick = () => document.getElementById('z-report-modal').classList.add('hidden');
        
        // (v3.7) Modified Z-Report Confirm (Now deletes orders and eating logs)
        document.getElementById('z-report-confirm-button').onclick = async () => {
// ... (existing code, no change) ...
        };

        // (v3.7) Modified showHist
        window.showHist = (id) => {
// ... (existing code, no change) ...
        };
        document.getElementById('history-detail-close-btn').onclick = () => document.getElementById('history-detail-modal').classList.add('hidden');

        // Init
        document.getElementById('admin-search-bar').oninput = renderProducts;
        document.getElementById('customer-search-bar').oninput = renderProducts;

        // (v3.1) Navigation Logic
        showStoreBtn.onclick = () => { 
// ... (existing code, no change) ...
        };
        showAdminBtn.onclick = () => { 
// ... (existing code, no change) ...
        };
        
        // (v3.1) Admin Login Modal Triggers
        document.getElementById('admin-login-btn').onclick = () => document.getElementById('admin-login-modal').classList.remove('hidden');
        document.getElementById('admin-login-modal-close').onclick = () => document.getElementById('admin-login-modal').classList.add('hidden');

        // (v3.1) Admin Login/Logout Logic
        document.getElementById('admin-login-form').onsubmit = async (e) => {
// ... (existing code, no change) ...
        };

        document.getElementById('admin-logout-btn').onclick = async () => {
// ... (existing code, no change) ...
        };
        
        // (v3.3) New Clear History Logic
        document.getElementById('show-clear-history-modal').onclick = () => {
// ... (existing code, no change) ...
        };
        document.getElementById('confirm-clear-cancel').onclick = () => {
// ... (existing code, no change) ...
        };
        document.getElementById('confirm-clear-confirm').onclick = async () => {
            await clearAllHistory();
            confirmClearModal.classList.add('hidden');
        };
        
        // (v3.7) Modified clearAllHistory
        async function clearAllHistory() {
// ... (existing code, no change) ...
        }


        // (v3.1) Central Auth Handler
        function setupAuthListener() {
// ... (existing code, no change) ...
        }
        
        // (v3.1) Function to setup data listeners
        function setupDataListeners() {
// ... (existing code, no change) ...
        }

        // (v3.1) Start the auth process
        setupAuthListener();

    </script>
</body>
</html>

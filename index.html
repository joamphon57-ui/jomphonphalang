<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านติดใจจอมพล</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ionicons (สำหรับไอคอน) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .product-sold-out { opacity: 0.6; filter: grayscale(80%); }
        #floating-cart-btn { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        
        /* (v4.3) For collapsible sections */
        details summary::-webkit-details-marker { display: none; }
        details summary { list-style: none; }
        details[open] .details-arrow { transform: rotate(180deg); }

        /* (v4.3) For category drag & drop */
        .category-item.dragging { opacity: 0.5; background: #f0fdf4; border: 2px dashed #22c55e; }
        .category-item .drag-handle { cursor: move; }
    </style>
</head>
<!-- (v4.3) FIX: Added overflow-x-hidden to prevent horizontal scroll -->
<body class="bg-slate-50 text-gray-800 overflow-x-hidden">

    <header class="bg-emerald-700 text-white shadow-md sticky top-0 z-20">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <ion-icon name="storefront-outline" class="text-3xl"></ion-icon>
                <h1 class="text-2xl font-bold">JomphonShop</h1>
            </div>
            <div class="flex space-x-3 items-center">
                <button id="show-store-btn" class="px-4 py-2 bg-white text-emerald-700 rounded-lg font-semibold hover:bg-gray-100 transition shadow flex items-center">
                    <ion-icon name="cart-outline" class="mr-1"></ion-icon> หน้าร้านค้า
                </button>
                <button id="show-admin-btn" class="px-4 py-2 bg-emerald-800 text-white rounded-lg font-semibold hover:bg-emerald-900 transition shadow flex items-center hidden">
                    <ion-icon name="settings-outline" class="mr-1"></ion-icon> แอดมิน
                </button>
                
                <button id="admin-login-btn" class="p-2 bg-white text-emerald-700 rounded-full font-semibold hover:bg-gray-100 transition shadow">
                    <ion-icon name="person-circle-outline" class="text-2xl block align-middle"></ion-icon>
                </button>
                <button id="admin-logout-btn" class="p-2 bg-emerald-800 text-white rounded-full font-semibold hover:bg-emerald-900 transition shadow hidden">
                    <ion-icon name="log-out-outline" class="text-2xl block align-middle"></ion-icon>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 lg:p-8">

        <!-- Firebase Info -->
        <div class="mb-4 p-3 bg-emerald-100 border border-emerald-300 rounded-lg text-xs text-emerald-800">
            <p><strong>App ID:</strong> <span id="app-id-display">...</span> | <strong>User ID:</strong> <span id="user-id-display">...</span> | <strong>Status:</strong> <span id="auth-status">...</span></p>
        </div>

        <!-- ========================= ADMIN SECTION ========================= -->
        <section id="admin-section" class="hidden">
            <h2 class="text-3xl font-bold text-emerald-800 mb-6">หน้าแอดมิน (Admin)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- LEFT COLUMN: Manage Products -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- (v3.6) REMOVED Manual Sale (Quick Sale) -->

                    <!-- (v4.3) MODIFIED: Collapsible Category Management -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <details open>
                            <summary class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between cursor-pointer list-none">
                                <div class="flex items-center">
                                    <ion-icon name="file-tray-stacked-outline" class="mr-2 text-2xl"></ion-icon>
                                    จัดการหมวดหมู่
                                </div>
                                <ion-icon name="chevron-down-outline" class="text-2xl transition-transform duration-200 details-arrow"></ion-icon>
                            </summary>
                            
                            <form id="add-category-form" class="p-6 space-y-4 mb-0">
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <div class="flex-grow">
                                        <label class="block text-sm font-medium text-gray-700">ชื่อหมวดหมู่ใหม่</label>
                                        <input type="text" id="category-name" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="เช่น เครื่องดื่ม, ขนม" required>
                                    </div>
                                    <div class="flex-shrink-0 flex items-end">
                                        <button type="submit" class="w-full sm:w-auto px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">เพิ่ม</button>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <input type="checkbox" id="category-track-stock" class="rounded text-emerald-600 focus:ring-emerald-500" checked>
                                    <label for="category-track-stock" class="ml-2 text-sm text-gray-700">ติดตามสต็อก (นับจำนวน)</label>
                                </div>
                            </form>
                            <div class="p-6 pt-4 text-sm text-gray-600 border-b border-gray-100">
                                <ion-icon name="information-circle-outline" class="align-middle"></ion-icon>
                                <strong>Tip:</strong> กดค้างที่ไอคอน ☰ เพื่อลากและวางสำหรับจัดลำดับใหม่
                            </div>
                            <div id="category-list" class="p-6 pt-4 space-y-2"></div>
                        </details>
                    </div>

                    <!-- (v4.3) MODIFIED: Collapsible Add/Edit Product -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <details open>
                             <summary class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between cursor-pointer list-none">
                                <div class="flex items-center">
                                    <ion-icon name="add-circle-outline" class="mr-2 text-2xl"></ion-icon>
                                    เพิ่ม / แก้ไขสินค้า
                                </div>
                                <ion-icon name="chevron-down-outline" class="text-2xl transition-transform duration-200 details-arrow"></ion-icon>
                            </summary>

                            <form id="add-product-form" class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">เลือกหมวดหมู่</label>
                                    <select id="product-category" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                        <option value="">-- กรุณาเลือกหมวดหมู่ --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ชื่อสินค้า</label>
                                    <input type="text" id="product-name" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">รูปภาพสินค้า</label>
                                    <input type="file" id="product-image-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                                    <div id="image-preview-container" class="mt-2 hidden">
                                        <img id="image-preview" src="" class="w-32 h-32 object-cover rounded border">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ราคา (1 ชิ้น)</label>
                                    <input type="number" id="product-price" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="product-promo-type" class="block text-sm font-medium text-gray-700">ประเภทโปรโมชั่น</label>
                                    <select id="product-promo-type" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                        <option value="BIG_BOTTLE">โปรขวดใหญ่: 2@150, 4@240 (น้ำปกติ)</option>
                                        <option value="SMALL_BOTTLE">โปรขวดเล็ก: 3@100</option>
                                        <option value="EXCLUDED">ราคาคงที่ (ไม่เข้าร่วมโปรเหมา เช่น น้ำดิบ)</option>
                                    </select>
                                </div>
                                <input type="hidden" id="product-id">
                                <div class="flex justify-end space-x-3 pt-2">
                                    <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">ยกเลิก</button>
                                    <button type="submit" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">
                                        <span id="submit-product-btn-text">เพิ่มสินค้าใหม่</span>
                                    </button>
                                </div>
                            </form>
                        </details>
                    </div>

                    <!-- (v4.3) MODIFIED: Collapsible Product List -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <details open>
                            <summary class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between cursor-pointer list-none">
                                <div class="flex items-center">
                                    <ion-icon name="list-outline" class="mr-2 text-2xl"></ion-icon>
                                    รายการสินค้า
                                </div>
                                <ion-icon name="chevron-down-outline" class="text-2xl transition-transform duration-200 details-arrow"></ion-icon>
                            </summary>

                            <div class="p-6">
                                <input type="text" id="admin-search-bar" placeholder="ค้นหา..." class="w-full px-3 py-2 border rounded-md mb-4">
                                <!-- (v4.3) MODIFIED: Admin list is now grouped by category -->
                                <div id="admin-product-list" class="space-y-4 max-h-[800px] overflow-y-auto pr-2"></div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Sidebar -->
                <div class="lg:col-span-1 space-y-6">

                    <!-- INCOMING ORDERS -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-bold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between">
                            <div class="flex items-center">
                                <ion-icon name="notifications-outline" class="mr-2 text-2xl"></ion-icon> ออเดอร์เข้าใหม่
                            </div>
                            <span id="pending-order-count" class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
                        </h3>
                        <div id="order-list" class="p-6 space-y-3 max-h-[400px] overflow-y-auto pr-1">
                            <p class="text-gray-500 text-center py-4">ยังไม่มีออเดอร์</p>
                        </div>
                    </div>

                    <!-- Z-Report -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="analytics-outline" class="mr-2 text-2xl"></ion-icon>
                            ยอดปัจจุบัน (รอตัดยอด)
                        </h3>
                        <div class="p-6 space-y-2 text-lg">
                            <div class="flex justify-between"><span>ยอดขาย:</span> <span id="sales-tally-total" class="font-bold text-green-700">0.00 บาท</span></div>
                            <div class="flex justify-between"><span>รายจ่าย:</span> <span id="expense-tally-total" class="font-bold text-red-600">0.00 บาท</span></div>
                        </div>
                        <div class="p-6 pt-0">
                            <button id="z-report-button" class="w-full px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">ตัดยอดรายวัน</button>
                        </div>
                    </div>

                    <!-- Z-Report History -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center justify-between">
                            <div class="flex items-center">
                                <ion-icon name="archive-outline" class="mr-2 text-2xl"></ion-icon> ประวัติการตัดยอด
                            </div>
                            <button id="show-clear-history-modal" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 font-semibold shadow">
                                ล้าง...
                            </button>
                        </h3>
                        <div id="z-report-history-list" class="p-6 space-y-2 max-h-[200px] overflow-y-auto text-sm"></div>
                    </div>
                    
                    <!-- (v4.3) MOVED: Expense moved up -->
                    <!-- Expense -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="wallet-outline" class="mr-2 text-2xl"></ion-icon>
                            บันทึกรายจ่าย
                        </h3>
                        <form id="add-expense-form" class="p-6 space-y-3">
                            <input type="hidden" id="expense-id">
                            <input type="text" id="expense-description" class="w-full px-3 py-2 border rounded-md" placeholder="รายการ (เช่น ค่าไฟ)" required>
                            <input type="number" id="expense-amount" class="w-full px-3 py-2 border rounded-md" placeholder="จำนวนเงิน" required>
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold shadow">
                                    <span id="submit-expense-btn-text">บันทึก</span>
                                </button>
                                <button type="button" id="cancel-expense-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">ยกเลิก</button>
                            </div>
                        </form>
                        <div id="expense-history-list" class="p-6 pt-2 space-y-2 max-h-[200px] overflow-y-auto text-sm border-t"></div>
                    </div>

                    <!-- (v4.3) MOVED: Stock Log History moved down -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="receipt-outline" class="mr-2 text-2xl"></ion-icon>
                            ประวัติการเติมสต็อก
                        </h3>
                        <div id="stock-history-list" class="p-6 space-y-2 max-h-[200px] overflow-y-auto text-sm">
                            <p class="text-gray-500">ยังไม่มีประวัติการเติม</p>
                        </div>
                    </div>

                    <!-- (v3.9) MODIFIED: Eating Log -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                        <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                            <ion-icon name="fast-food-outline" class="mr-2 text-2xl"></ion-icon>
                            บันทึกการกิน (ตัดสต็อก)
                        </h3>
                        <form id="add-eating-log-form" class="p-6 space-y-3">
                            <input type="hidden" id="eat-log-id"> <!-- (v3.9) New -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700">เลือกหมวดหมู่ที่กิน</label>
                                <select id="eat-category-select" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                                    <option value="">-- เลือกหมวดหมู่ --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">จำนวน (ชิ้น)</label>
                                    <input type="number" id="eat-quantity" class="w-full px-3 py-2 border rounded-md" placeholder="1" required min="1" value="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ชื่อคนกิน</label>
                                    <input type="text" id="eat-person" class="w-full px-3 py-2 border rounded-md" placeholder="ชื่อ..." required>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold shadow">
                                    <span id="submit-eat-log-btn-text">บันทึก</span>
                                </button>
                                <button type="button" id="cancel-eat-log-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hidden">ยกเลิก</button>
                            </div>
                        </form>
                        <div id="eating-log-history-list" class="p-6 pt-2 space-y-2 max-h-[200px] overflow-y-auto text-sm border-t">
                            <p class="text-gray-500">ยังไม่มีประวัติการกิน</p>
                        </div>
                    </div>
                    
                </div>
            </div>
        </section>

        <!-- ========================= CUSTOMER SECTION ========================= -->
        <section id="store-section">
            <h2 class="text-3xl font-bold text-emerald-800 mb-6">หน้าร้านค้า</h2>
            <div id="category-tabs" class="flex overflow-x-auto whitespace-nowrap space-x-3 mb-6 p-1 bg-gray-200 rounded-lg shadow-inner no-scrollbar sticky top-[88px] z-10">
                <!-- (v4.3) Tabs will be rendered here, including "Recommended" -->
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                <div class="lg:col-span-1">
                    <div class="mb-4">
                        <input type="text" id="customer-search-bar" placeholder="ค้นหาสินค้า..." class="w-full px-4 py-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <!-- Product List (Grid) -->
                    <div id="customer-product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Floating Cart Button -->
    <button id="floating-cart-btn" class="bg-red-600 text-white p-4 rounded-full shadow-2xl hover:bg-red-700 transition transform hover:scale-105 relative" onclick="document.getElementById('cart-modal').classList.remove('hidden')">
        <ion-icon name="cart-outline" class="text-2xl"></ion-icon>
        <span id="cart-item-count" class="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4 bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ring-2 ring-white hidden">0</span>
    </button>

    <!-- ========================= MODALS ========================= -->

    <!-- (v3.1) Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-semibold text-gray-800">ล็อกอินแอดมิน</h3>
                <button id="admin-login-modal-close" class="text-gray-500 hover:text-gray-700">
                    <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                </button>
            </div>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">อีเมล</label>
                    <input type="email" id="admin-email" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                </div>
                <button type="submit" class="w-full px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow">
                    ล็อกอิน
                </button>
            </form>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 pb-4 border-b">
                <h3 class="text-xl font-semibold text-gray-800">ตะกร้าสินค้า</h3>
                <button onclick="document.getElementById('cart-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                    <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div id="cart-items" class="p-6 space-y-3 overflow-y-auto no-scrollbar">
                <!-- Cart items go here -->
            </div>
            <p id="cart-empty-msg" class="text-center text-gray-500 p-6">ตะกร้าว่างเปล่า</p>
            <div class="p-6 border-t mt-auto space-y-4 bg-gray-50 rounded-b-xl">
                <div class="flex justify-between text-xl font-bold">
                    <span>ยอดรวม:</span> 
                    <span id="cart-total" class="text-emerald-700">0.00 บาท</span>
                </div>
                <form id="checkout-form">
                    <button id="checkout-button" type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-semibold shadow-lg" disabled>
                        สั่งซื้อ (Checkout)
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Global Modals (Other Modals) -->
    <div id="global-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 text-center">
            <p id="global-modal-message" class="text-lg text-gray-800 mb-6"></p>
            <button id="global-modal-close" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">ตกลง</button>
        </div>
    </div>
    <div id="update-stock-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 overflow-hidden">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">อัปเดตสต็อก: <span id="update-stock-category-name" class="ml-2"></span></h3>
            <form id="update-stock-form" class="p-6 space-y-4">
                <input type="hidden" id="update-stock-category-id">
                <input type="number" id="stock-adjustment" placeholder="+ เพิ่ม หรือ - ลด" class="w-full px-3 py-2 border rounded-md" required>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="update-stock-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">ยืนยัน</button>
                </div>
            </form>
        </div>
    </div>

    <!-- (v4.0) New: Edit Category Modal -->
    <div id="edit-category-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 overflow-hidden">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                <ion-icon name="pencil-outline" class="mr-2 text-2xl"></ion-icon>
                แก้ไขหมวดหมู่
            </h3>
            <form id="edit-category-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-category-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ชื่อหมวดหมู่</label>
                    <input type="text" id="edit-category-name" class="mt-1 block w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                    <input type="checkbox" id="edit-category-track-stock" class="rounded text-emerald-600 focus:ring-emerald-500">
                    <label for="edit-category-track-stock" class="ml-2 text-sm text-gray-700">ติดตามสต็อก (นับจำนวน)</label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-category-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="z-report-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                <ion-icon name="document-text-outline" class="mr-2 text-2xl"></ion-icon> สรุปยอด (Z-Report)
            </h3>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div><h4 class="text-green-700 font-bold">1. รายรับ</h4><div id="z-report-sales-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-green-200"></div></div>
                <div><h4 class="text-red-700 font-bold">2. รายจ่าย</h4><div id="z-report-expense-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-red-200"></div></div>
                <div><h4 class="text-blue-700 font-bold">3. สต็อกคงเหลือ</h4><div id="z-report-stock-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-blue-200"></div></div>
                <div><h4 class="text-yellow-700 font-bold">4. ประวัติการเติมสต็อก (รอบนี้)</h4><div id="z-report-stock-refill-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-yellow-200"></div></div>
                <!-- (v3.7) New: Eating Log Summary -->
                <div><h4 class="text-orange-700 font-bold">5. ประวัติการกิน (รอบนี้)</h4><div id="z-report-eating-log-details" class="ml-2 text-sm text-gray-600 border-l-2 pl-2 border-orange-200"></div></div>
            </div>
            <div class="p-6 border-t mt-auto space-y-1 font-bold bg-gray-50 rounded-b-xl">
                <div class="flex justify-between text-green-700"><span>ยอดขาย:</span><span id="z-report-total-sales">0.00</span></div>
                <div class="flex justify-between text-red-700"><span>รายจ่าย:</span><span id="z-report-total-expense">0.00</span></div>
                <div class="flex justify-between text-blue-800 border-t mt-2 pt-2 text-lg"><span>กำไรสุทธิ:</span><span id="z-report-net-profit">0.00</span></div>
            </div>
            <div class="flex justify-end space-x-3 p-6 pt-4 bg-gray-50">
                <button id="z-report-cancel-button" class="px-4 py-2 bg-gray-200 rounded-lg">ยกเลิก</button>
                <button id="z-report-confirm-button" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg">ยืนยันตัดยอด</button>
            </div>
        </div>
    </div>
    <div id="history-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 max-h-[90vh] overflow-hidden flex flex-col">
            <h3 class="text-xl font-semibold text-white p-4 bg-gradient-to-r from-emerald-600 to-green-600 flex items-center">
                <ion-icon name="archive-outline" class="mr-2 text-2xl"></ion-icon> รายละเอียดประวัติ
            </h3>
            <div id="history-detail-content" class="p-6 space-y-4 overflow-y-auto"></div>
            <div class="flex justify-end mt-auto p-6 border-t bg-gray-50 rounded-b-xl">
                <button id="history-detail-close-btn" class="px-4 py-2 bg-gray-200 rounded-lg">ปิด</button>
            </div>
        </div>
    </div>

    <!-- (v3.3) Confirm Clear History Modal -->
    <div id="confirm-clear-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 text-center">
            <h3 class="text-xl font-semibold text-red-700 mb-4">ยืนยันการล้างประวัติ</h3>
            <p id="confirm-clear-message" class="text-lg text-gray-800 mb-6">คุณแน่ใจหรือไม่ว่าต้องการล้างประวัติ (ตัดยอด, เติมสต็อก, รายจ่ายที่เคลียร์แล้ว, ประวัติการกิน)?<br><strong class="text-red-600">การกระทำนี้ "ไม่สามารถย้อนกลับได้"</strong></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-clear-cancel" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="confirm-clear-confirm" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">ยืนยันการล้าง</button>
            </div>
        </div>
    </div>

    <!-- (v4.2) New: Generic Confirm Modal -->
    <div id="generic-confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 text-center">
            <h3 class="text-xl font-semibold text-yellow-700 mb-4">โปรดยืนยัน</h3>
            <p id="generic-confirm-message" class="text-lg text-gray-800 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="generic-confirm-cancel" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="generic-confirm-confirm" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">ยืนยัน</button>
            </div>
        </div>
    </div>


    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithEmailAndPassword, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            orderBy, 
            addDoc, 
            writeBatch, 
            serverTimestamp, 
            increment, 
            runTransaction, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcIa3RBMd1-kt9tOO6tdUDXbRrz0lLWl8",
            authDomain: "jomphonshop.firebaseapp.com",
            projectId: "jomphonshop",
            storageBucket: "jomphonshop.firebasestorage.app",
            messagingSenderId: "479449480163",
            appId: "1:479449480163:web:a0179b60c6983ef9437ed6",
            measurementId: "G-XH44BT8W7B"
        };

        const app = initializeApp(firebaseConfig);
        let db, auth, userId, currentImageBase64 = "";
        let localProducts = [], localOrders = [], localCategories = [], localExpenses = [], localReportHistory = [], cart = [];
        let localStockHistory = []; 
        let localEatingHistory = []; 
        let activeCategoryFilter = 'ALL'; // (v4.3) MODIFIED: 'RECOMMENDED' is a new valid value
        let listenersInitialized = false; 

        // --- Promotion Rule Sets (v2.9) ---
        const PROMO_RULE_SETS = {
            'EXCLUDED': null, 
            'BIG_BOTTLE': [{ quantity: 4, price: 240 }, { quantity: 2, price: 150 }, { quantity: 1, price: 80 }],
            'SMALL_BOTTLE': [{ quantity: 3, price: 100 }, { quantity: 1, price: 40 }]
        };

        // UI Elements
        const showModal = (msg) => { document.getElementById('global-modal-message').textContent = msg; document.getElementById('global-modal').classList.remove('hidden'); };
        document.getElementById('global-modal-close').onclick = () => document.getElementById('global-modal').classList.add('hidden');
        
        const storeSection = document.getElementById('store-section');
        const adminSection = document.getElementById('admin-section');
        const showStoreBtn = document.getElementById('show-store-btn');
        const showAdminBtn = document.getElementById('show-admin-btn');
        const appId = "jomphonshop"; 
        const stockHistoryList = document.getElementById('stock-history-list'); 
        const confirmClearModal = document.getElementById('confirm-clear-modal'); 

        // (v4.2) New Generic Confirm Modal UI
        const genericConfirmModal = document.getElementById('generic-confirm-modal');
        const genericConfirmMessage = document.getElementById('generic-confirm-message');
        const genericConfirmCancel = document.getElementById('generic-confirm-cancel');
        const genericConfirmConfirm = document.getElementById('generic-confirm-confirm');
        let onConfirmAction = () => {}; 

        window.showConfirmModal = (message, callback) => {
            genericConfirmMessage.textContent = message;
            onConfirmAction = callback; 
            genericConfirmModal.classList.remove('hidden');
        };
        genericConfirmCancel.onclick = () => {
            genericConfirmModal.classList.add('hidden');
            onConfirmAction = () => {}; 
        };
        genericConfirmConfirm.onclick = () => {
            genericConfirmModal.classList.add('hidden');
            onConfirmAction(); 
            onConfirmAction = () => {}; 
        };
        
        const addEatingLogForm = document.getElementById('add-eating-log-form');
        const eatCategorySelect = document.getElementById('eat-category-select'); 
        const eatingLogHistoryList = document.getElementById('eating-log-history-list');
        const eatLogIdInput = document.getElementById('eat-log-id');
        const cancelEatLogBtn = document.getElementById('cancel-eat-log-btn');
        const submitEatLogBtnText = document.getElementById('submit-eat-log-btn-text');

        const editCategoryModal = document.getElementById('edit-category-modal');
        const editCategoryForm = document.getElementById('edit-category-form');
        const editCategoryId = document.getElementById('edit-category-id');
        const editCategoryName = document.getElementById('edit-category-name');
        const editCategoryTrackStock = document.getElementById('edit-category-track-stock');

        // (v4.3) Drag and Drop state
        let draggedItem = null;

        // Image Compression
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 400 / img.width;
                        canvas.width = 400; canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.onerror = reject;
            });
        }
        document.getElementById('product-image-file').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                try { 
                    currentImageBase64 = await compressImage(e.target.files[0]); 
                    document.getElementById('image-preview').src = currentImageBase64; 
                    document.getElementById('image-preview-container').classList.remove('hidden'); 
                } 
                catch(err) { showModal("อ่านรูปไม่ได้"); }
            }
        });

        // Listeners & Renderers
        // (v4.3) MODIFIED: Added sorting, drag handles, and "Recommended" tab
        function renderCategories() {
            const list = document.getElementById('category-list');
            const select = document.getElementById('product-category');
            const tabsContainer = document.getElementById('category-tabs');
            const eatCategorySelect = document.getElementById('eat-category-select');
            
            // (v4.6) FIX: If the filter was stuck on 'RECOMMENDED' (which no longer exists), reset to 'ALL'.
            if (activeCategoryFilter === 'RECOMMENDED') {
                activeCategoryFilter = 'ALL';
            }
            
            list.innerHTML = ''; 
            select.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
            tabsContainer.innerHTML = '';
            eatCategorySelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';

            // (v4.3) Sort categories based on the 'order' field
            const sortedCategories = localCategories.sort((a, b) => (a.order || 0) - (b.order || 0));

            // (v4.3) Render 'Recommended' Tab first
            /* (v4.6) REMOVED 'Recommended' Tab
            const recommendedTabClass = activeCategoryFilter === 'RECOMMENDED' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-100';
            tabsContainer.innerHTML += `
                <button onclick="window.setCategoryFilter('RECOMMENDED')" class="px-4 py-2 rounded-lg font-semibold transition ${recommendedTabClass}">⭐ แนะนำ</button>
            `;
            */

            // 1. Render 'All' Tab
            const allTabClass = activeCategoryFilter === 'ALL' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-100';
            tabsContainer.innerHTML += `
                <button onclick="window.setCategoryFilter('ALL')" class="px-4 py-2 rounded-lg font-semibold transition ${allTabClass}">ทั้งหมด</button>
            `;

            sortedCategories.forEach(c => {
                // Populate dropdowns (respecting new order)
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                eatCategorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; 

                const stockDisplay = c.isStockTracked 
                    ? `(<span class="font-bold ${c.remainingStock <= 5 ? 'text-red-600' : 'text-gray-800'}">${c.remainingStock}</span> / ${c.totalStock} ชิ้น)`
                    : `(<span class="text-blue-600">ไม่นับสต็อก</span>)`;
                
                const stockButton = c.isStockTracked
                    ? `<button onclick="window.openStock('${c.id}','${c.name}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">สต็อก</button>`
                    : ''; 

                const editButtons = `
                    <div class="flex-shrink-0 flex gap-2 ml-2 items-center">
                        ${stockButton}
                        <button onclick="window.editCategory('${c.id}')" class="text-xs bg-yellow-500 text-white px-2 py-1 rounded">แก้</button>
                        <button onclick="window.deleteCategory('${c.id}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded">ลบ</button>
                    </div>
                `;

                // (v4.3) Render admin list with drag handle
                list.innerHTML += `
                    <div class="category-item flex justify-between items-center p-2 bg-gray-50 rounded border" draggable="true" data-id="${c.id}">
                        <div class="flex items-center">
                            <span class="drag-handle text-gray-400 text-xl mr-2"><ion-icon name="reorder-three-outline"></ion-icon></span>
                            <div>
                                <span class="font-bold text-emerald-800">${c.name}</span>
                                <p class="text-sm text-gray-600">คงเหลือ: ${stockDisplay}</p>
                            </div>
                        </div>
                        ${editButtons}
                    </div>`;

                // Render Category Tabs (respecting new order)
                const tabClass = activeCategoryFilter === c.id ? 'bg-emerald-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-100';
                tabsContainer.innerHTML += `
                    <button onclick="window.setCategoryFilter('${c.id}')" class="px-4 py-2 rounded-lg font-semibold transition ${tabClass}">${c.name}</button>
                `;
            });

            // (v4.3) Add drag-and-drop event listeners to the category list
            addDragDropListeners();
        }

        // (v4.3) New: Drag and Drop Listeners
        function addDragDropListeners() {
            const list = document.getElementById('category-list');
            const items = list.querySelectorAll('.category-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('.category-item');
                    setTimeout(() => e.target.closest('.category-item').classList.add('dragging'), 0);
                    e.dataTransfer.effectAllowed = 'move';
                });
                item.addEventListener('dragend', (e) => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                });
            });

            list.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(list, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    if (afterElement == null) {
                        list.appendChild(dragging);
                    } else {
                        list.insertBefore(dragging, afterElement);
                    }
                }
            });

            list.addEventListener('drop', async (e) => {
                e.preventDefault();
                const children = Array.from(list.querySelectorAll('.category-item'));
                const batch = writeBatch(db);
                
                children.forEach((child, index) => {
                    const id = child.dataset.id;
                    const docRef = doc(db, `artifacts/${appId}/public/data/categories`, id);
                    batch.update(docRef, { order: index });
                });
                
                try {
                    await batch.commit();
                    showModal("จัดลำดับหมวดหมู่ใหม่แล้ว!");
                    // Snapshot will refresh the UI
                } catch (err) {
                    console.error("Error reordering: ", err);
                    showModal("เกิดข้อผิดพลาดในการจัดลำดับ");
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.category-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // (v4.3) MODIFIED: Handle 'RECOMMENDED' filter
        window.setCategoryFilter = (categoryId) => {
            activeCategoryFilter = categoryId;
            renderCategories(); // Rerender to highlight the active tab
            renderProducts();   // Rerender products with the new filter
        };

        function renderOrders() {
            const list = document.getElementById('order-list');
            list.innerHTML = '';
            const visible = localOrders
                .filter(o => o.status === 'pending' || (o.status === 'paid' && o.reportStatus === 'pending'))
                .sort((a, b) => {
                    const da = a.createdAt?.toDate ? a.createdAt.toDate() : new Date();
                    const db = b.createdAt?.toDate ? b.createdAt.toDate() : new Date();
                    return db - da; 
                });

            if(visible.length === 0) { list.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีออเดอร์</p>'; return; }
            
            let pendingCount = 0;

            visible.forEach(o => {
                if(o.status === 'pending') pendingCount++;
                const time = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) : '...';
                const items = o.items.map(i => `${i.name} x${i.quantity}`).join(', ');
                const statusClass = o.status === 'paid' ? 'bg-green-100 border-green-300' : (o.status === 'pending' ? 'bg-yellow-50 border-yellow-300 shadow-md' : 'bg-gray-100');
                
                let btnHtml = '';
                if (o.status === 'pending') {
                    btnHtml = `<div class="flex gap-2 mt-2 justify-end"><button onclick="window.pay('${o.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">ชำระแล้ว</button><button onclick="window.cancel('${o.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm">ยกเลิก</button></div>`;
                } else if (o.status === 'paid' && o.reportStatus === 'pending') {
                     btnHtml = `<div class="flex justify-end mt-1"><span class="text-xs text-green-700">(รอตัดยอด)</span></div>`;
                }
                
                list.innerHTML += `
                    <div class="p-3 rounded border ${statusClass}">
                        <div class="flex justify-between text-xs text-gray-500 mb-1"><span>เวลา: ${time}</span> <span class="font-bold ${o.status==='paid'?'text-green-700':'text-yellow-700'}">${o.status==='paid'?'จ่ายแล้ว':'รอชำระ'}</span></div>
                        <div class="text-sm text-gray-800 font-medium truncate">${items}</div>
                        <div class="text-right font-bold text-emerald-700 mt-1">${o.totalPrice.toFixed(2)} บ.</div>
                        ${btnHtml}
                    </div>`;
            });

            const badge = document.getElementById('pending-order-count');
            if(pendingCount > 0) { badge.textContent = pendingCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
        }

        // (v4.4) MODIFIED: Added Uncategorized group
        function renderProducts() {
            const adminList = document.getElementById('admin-product-list');
            const custList = document.getElementById('customer-product-list');
            const adminSearch = document.getElementById('admin-search-bar').value.toLowerCase();
            const custSearch = document.getElementById('customer-search-bar').value.toLowerCase();
            
            adminList.innerHTML = ''; custList.innerHTML = '';
            
            // (v4.3) Sort categories by order
            const sortedCategories = localCategories.sort((a, b) => (a.order || 0) - (b.order || 0));

            // (v4.3) Admin View: Grouped by Category
            sortedCategories.forEach(cat => {
                const productsInCategory = localProducts
                    .filter(p => p.categoryId === cat.id && p.name.toLowerCase().includes(adminSearch))
                    .sort((a, b) => a.name.localeCompare(b.name)); // Sort products alphabetically within category

                if (productsInCategory.length === 0) return;

                let productHtml = '';
                productsInCategory.forEach(p => {
                    const img = p.imageUrl || `https://placehold.co/400x300/eee/999?text=${encodeURIComponent(p.name)}`;
                    const promoText = p.promoType === 'EXCLUDED' ? 'ราคาคงที่' : 
                                      p.promoType === 'BIG_BOTTLE' ? 'โปรขวดใหญ่' : 
                                      p.promoType === 'SMALL_BOTTLE' ? 'โปรขวดเล็ก' : 'N/A';
                    
                    // (v4.3) Recommended (Star) button
                    /* (v4.6) REMOVED Recommend Button
                    const recommendIcon = p.isRecommended ? 'star' : 'star-outline';
                    const recommendColor = p.isRecommended ? 'text-yellow-500' : 'text-gray-400';
                    const recommendButton = `
                        <button onclick="window.toggleRecommended('${p.id}', ${p.isRecommended || false})" class="text-xl ${recommendColor} hover:text-yellow-500">
                            <ion-icon name="${recommendIcon}"></ion-icon>
                        </button>`;
                    */

                    productHtml += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border ml-4">
                            <div class="flex items-center gap-3">
                                <img src="${img}" class="w-12 h-12 object-cover rounded border">
                                <div><div class="font-bold text-sm">${p.name}</div><div class="text-xs text-gray-500">${p.basePrice} บ. (${promoText})</div></div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <!-- (v4.6) REMOVED recommendButton -->
                                <button onclick="window.toggleStock('${p.id}',${p.isOutOfStock})" class="text-xs px-2 py-1 rounded text-white ${p.isOutOfStock?'bg-gray-500':'bg-green-500'}">${p.isOutOfStock?'ปิด':'เปิด'}</button>
                                <button onclick="window.editProd('${p.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded">แก้</button>
                                <button onclick="window.delProd('${p.id}')" class="text-xs px-2 py-1 bg-red-600 text-white rounded">ลบ</button>
                            </div>
                        </div>`;
                });

                adminList.innerHTML += `
                    <div class="mb-4">
                        <h4 class="font-bold text-lg text-emerald-700 mb-2 border-b border-emerald-200 pb-1">${cat.name}</h4>
                        <div class="space-y-2">${productHtml}</div>
                    </div>
                `;
            });

            // (v4.4) New: Render uncategorized products
            const uncategorizedProducts = localProducts
                .filter(p => (!p.categoryId || !localCategories.some(c => c.id === p.categoryId)) && p.name.toLowerCase().includes(adminSearch))
                .sort((a, b) => a.name.localeCompare(b.name));

            if (uncategorizedProducts.length > 0) {
                let productHtml = '';
                uncategorizedProducts.forEach(p => {
                    const img = p.imageUrl || `https://placehold.co/400x300/eee/999?text=${encodeURIComponent(p.name)}`;
                    const promoText = p.promoType === 'EXCLUDED' ? 'ราคาคงที่' : 
                    // (v4.3) Recommended (Star) button
                    /* (v4.6) REMOVED Recommend Button
                    const recommendIcon = p.isRecommended ? 'star' : 'star-outline';
                    const recommendColor = p.isRecommended ? 'text-yellow-500' : 'text-gray-400';
                    const recommendButton = `
                        <button onclick="window.toggleRecommended('${p.id}', ${p.isRecommended || false})" class="text-xl ${recommendColor} hover:text-yellow-500">
                            <ion-icon name="${recommendIcon}"></ion-icon>
                        </button>`;
                    */

                    productHtml += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border ml-4">
                            <div class="flex items-center gap-3">
                                <img src="${img}" class="w-12 h-12 object-cover rounded border">
                                <div><div class="font-bold text-sm">${p.name}</div><div class="text-xs text-gray-500">${p.basePrice} บ. (${promoText})</div></div>
                            </div>
                            <div class="flex gap-2 items-center">
                                <!-- (v4.6) REMOVED recommendButton -->
                                <button onclick="window.toggleStock('${p.id}',${p.isOutOfStock})" class="text-xs px-2 py-1 rounded text-white ${p.isOutOfStock?'bg-gray-500':'bg-green-500'}">${p.isOutOfStock?'ปิด':'เปิด'}</button>
                                <button onclick="window.editProd('${p.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded">แก้</button>
                                <button onclick="window.delProd('${p.id}')" class="text-xs px-2 py-1 bg-red-600 text-white rounded">ลบ</button>
                            </div>
                        </div>`;
                });

                adminList.innerHTML += `
                    <div class="mb-4">
                        <h4 class="font-bold text-lg text-gray-500 mb-2 border-b border-gray-200 pb-1 italic">(สินค้าไม่มีหมวดหมู่)</h4>
                        <div class="space-y-2">${productHtml}</div>
                    </div>
                `;
            }
            

            // (v4.3) Customer View: Filter logic updated for "Recommended"
            localProducts.forEach(p => {
                const cat = localCategories.find(c => c.id === p.categoryId);
                
                let isSoldOut = p.isOutOfStock; 
                if (cat && cat.isStockTracked && cat.remainingStock <= 0) { isSoldOut = true; }
                if (cat && !cat.isStockTracked) { isSoldOut = false; }
                
                const img = p.imageUrl || `https://placehold.co/400x300/eee/999?text=${encodeURIComponent(p.name)}`;
                
                // (v4.6) Customer Filter Logic (Removed RECOMMENDED)
                const passesSearch = p.name.toLowerCase().includes(custSearch);
                const passesCategoryFilter = activeCategoryFilter === 'ALL' || 
                                             p.categoryId === activeCategoryFilter;

                if(passesSearch && passesCategoryFilter) {
                    let promoDetail = '';
                    let promoColor = 'bg-red-600';
                    if(p.promoType === 'BIG_BOTTLE') { promoDetail = '2ชิ้น 150 | 4ชิ้น 240'; promoColor = 'bg-red-600'; }
                    else if(p.promoType === 'SMALL_BOTTLE') { promoDetail = '3ชิ้น 100 บาท!'; promoColor = 'bg-pink-600'; }
                    else if(p.promoType === 'EXCLUDED') { promoDetail = 'สินค้าราคาต่อชิ้น'; promoColor = 'bg-yellow-600'; }

                    // (v4.3) Recommended Badge
                    /* (v4.6) REMOVED Recommend Badge
                    const recommendBadge = p.isRecommended 
                        ? `<div class="absolute top-2 right-2 text-yellow-400 bg-black/50 p-1 rounded-full"><ion-icon name="star" class="text-sm block align-middle"></ion-icon></div>` 
                        : '';
                    */

                    custList.innerHTML += `
                        <div class="bg-white rounded-xl shadow border overflow-hidden flex flex-col justify-between ${isSoldOut ? 'product-sold-out' : 'hover:shadow-md'}">
                            <div class="relative">
                                <img src="${img}" class="w-full aspect-square object-cover" onerror="this.src='https://placehold.co/400x300/eee/999?text=Error'">
                                ${isSoldOut ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">หมด</div>' : ''}
                                <div class="absolute top-2 left-2 text-white text-[10px] font-bold px-2 py-1 rounded ${promoColor}">${p.promoType}</div>
                                <!-- (v4.6) REMOVED recommendBadge -->
                            </div>
                            <div class="p-3 flex flex-col flex-grow">
                                <h4 class="font-bold truncate">${p.name}</h4>
                                <p class="text-sm text-gray-500">${p.basePrice} บ.</p>
                                <div class="text-xs text-emerald-700 my-2">${promoDetail}</div>
                                <div class="mt-auto">
                                    <button onclick="window.addCart('${p.id}')" class="w-full py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded text-sm" ${isSoldOut?'disabled':''}>${isSoldOut?'หมด':'ใส่ตะกร้า'}</button>
                                </div>
                            </div>
                        </div>`;
                }
            });
        }

        // --- Helper Function to apply specific rules ---
        function applyPromoRules(quantity, rules) {
            if (quantity === 0 || !rules || rules.length === 0) return 0;
            
            let finalPrice = 0;
            let remainingQty = quantity;
            
            const sortedRules = [...rules].sort((a, b) => b.quantity - a.quantity);

            for (const rule of sortedRules) {
                if (remainingQty >= rule.quantity) {
                    const times = Math.floor(remainingQty / rule.quantity);
                    finalPrice += times * rule.price;
                    remainingQty %= rule.quantity;
                }
            }
            return finalPrice;
        }

        // (v2.9 Logic) Pricing Logic: ใช้ราคาเหมา 240 ถ้าได้ประโยชน์ (รวมทุกชิ้น)
        function calculateFinalPrice(cartItems) {
            let totalFixedPrice = 0;
            let totalBigBottleQty = 0; 
            let totalSmallBottleQty = 0; 
            let totalQuantity = 0;

            cartItems.forEach(cartItem => {
                const product = localProducts.find(p => p.id === cartItem.id);
                if (!product) return;
                totalQuantity += cartItem.quantity;

                if (product.promoType === 'EXCLUDED') {
                    totalFixedPrice += cartItem.quantity * product.basePrice;
                } else if (product.promoType === 'BIG_BOTTLE') {
                    totalBigBottleQty += cartItem.quantity;
                } else if (product.promoType === 'SMALL_BOTTLE') {
                    totalSmallBottleQty += cartItem.quantity;
                }
            });

            const priceBig = applyPromoRules(totalBigBottleQty, PROMO_RULE_SETS.BIG_BOTTLE);
            const priceSmall = applyPromoRules(totalSmallBottleQty, PROMO_RULE_SETS.SMALL_BOTTLE);
            
            let defaultFinalPrice = totalFixedPrice + priceBig + priceSmall;

            // Global 4-item Override Check (The 3 แถม 1 rule)
            if (totalQuantity === 4 && defaultFinalPrice > 240) { 
                 return 240;
            }

            return defaultFinalPrice;
        }


        function renderCart() {
            const list = document.getElementById('cart-items');
            list.innerHTML = '';
            let totalQty = 0;

            cart.forEach(c => {
                const p = localProducts.find(x => x.id === c.id);
                if(p) {
                    totalQty += c.quantity;
                    list.innerHTML += `
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="text-sm font-medium">${p.name}</span>
                            <div class="flex items-center gap-2">
                                <button onclick="window.modCart('${c.id}',-1)" class="bg-gray-200 px-2 rounded hover:bg-gray-300">-</button>
                                <span class="text-sm font-bold">${c.quantity}</span>
                                <button onclick="window.modCart('${c.id}',1)" class="bg-gray-200 px-2 rounded hover:bg-gray-300">+</button>
                                <button onclick="window.modCart('${c.id}',0)" class="text-red-500 ml-1 hover:text-red-700">x</button>
                            </div>
                        </div>`;
                }
            });
            
            const finalPrice = calculateFinalPrice(cart); 
            document.getElementById('cart-total').textContent = finalPrice.toFixed(2) + ' บาท';
            document.getElementById('cart-empty-msg').classList.toggle('hidden', cart.length > 0);
            document.getElementById('checkout-button').disabled = cart.length === 0;
            
            const cartCountBadge = document.getElementById('cart-item-count');
            if(totalQty > 0) {
                cartCountBadge.textContent = totalQty;
                cartCountBadge.classList.remove('hidden');
            } else {
                cartCountBadge.classList.add('hidden');
                document.getElementById('cart-modal').classList.add('hidden');
            }

            document.getElementById('checkout-button').onclick = async (e) => {
                e.preventDefault();
                const items = cart.map(c => { const p=localProducts.find(x=>x.id===c.id); return {id:c.id, name:p.name, quantity:c.quantity, categoryId:p.categoryId}; });
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), {
                        items, totalPrice: finalPrice, status: 'pending', reportStatus: 'pending', createdAt: serverTimestamp()
                    });
                    cart = []; renderCart(); showModal('สั่งซื้อเรียบร้อย! รอแอดมินยืนยัน');
                    document.getElementById('cart-modal').classList.add('hidden');
                } catch(err) { showModal('เกิดข้อผิดพลาด'); }
            };
        }

        // Global Actions
        window.openStock = (id, name) => { document.getElementById('update-stock-category-id').value = id; document.getElementById('update-stock-category-name').textContent = name; document.getElementById('update-stock-modal').classList.remove('hidden'); };
        document.getElementById('update-stock-cancel').onclick = () => document.getElementById('update-stock-modal').classList.add('hidden');
        
        document.getElementById('update-stock-form').onsubmit = async (e) => {
            e.preventDefault();
            const categoryId = document.getElementById('update-stock-category-id').value;
            const adjustment = parseInt(document.getElementById('stock-adjustment').value);
            const categoryName = document.getElementById('update-stock-category-name').textContent;

            if (isNaN(adjustment) || adjustment === 0) {
                showModal("กรุณาใส่ตัวเลขที่ถูกต้อง");
                return;
            }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/categories`, categoryId), {
                    totalStock: increment(adjustment),
                    remainingStock: increment(adjustment)
                });

                if (adjustment > 0) {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/stockHistory`), {
                        categoryId: categoryId,
                        categoryName: categoryName,
                        amountAdded: adjustment,
                        createdAt: serverTimestamp()
                    });
                }

                document.getElementById('update-stock-modal').classList.add('hidden');
                document.getElementById('stock-adjustment').value = '';
                showModal("อัปเดตสต็อกสำเร็จ!");
            } catch(err) { 
                console.error("Error updating stock: ", err);
                showModal('Error: ' + err.message); 
            }
        };

        window.toggleStock = async (id, state) => await updateDoc(doc(db, `artifacts/${appId}/public/data/products`, id), { isOutOfStock: !state });
        
        // (v4.3) New: Toggle Recommended
        /* (v4.6) REMOVED toggleRecommended
        window.toggleRecommended = async (id, state) => {
             await updateDoc(doc(db, `artifacts/${appId}/public/data/products`, id), { isRecommended: !state });
        }
        */

        window.delProd = (id) => {
            window.showConfirmModal('ยืนยันการลบสินค้านี้?', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, id));
                    showModal('ลบสินค้าแล้ว');
                } catch(err) { showModal('ลบไม่สำเร็จ: ' + err.message); }
            });
        };
        
        window.editProd = (id) => {
            const p = localProducts.find(x => x.id === id);
            document.getElementById('product-id').value = p.id; 
            document.getElementById('product-name').value = p.name; 
            document.getElementById('product-price').value = p.basePrice; 
            document.getElementById('product-category').value = p.categoryId;
            document.getElementById('product-promo-type').value = p.promoType || 'BIG_BOTTLE'; 
            currentImageBase64 = p.imageUrl || ""; 
            if(currentImageBase64) { document.getElementById('image-preview').src = currentImageBase64; document.getElementById('image-preview-container').classList.remove('hidden'); }
            document.getElementById('cancel-edit-btn').classList.remove('hidden'); document.getElementById('submit-product-btn-text').textContent = "บันทึก";
            
            // (v4.3) Scroll to and open the "Add/Edit" details section
            const addProductDetails = document.getElementById('add-product-form').closest('details');
            if (addProductDetails) {
                addProductDetails.open = true;
                addProductDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };
        document.getElementById('cancel-edit-btn').onclick = () => { 
            document.getElementById('add-product-form').reset(); 
            document.getElementById('product-id').value=''; 
            document.getElementById('cancel-edit-btn').classList.add('hidden'); 
            document.getElementById('image-preview-container').classList.add('hidden'); 
            currentImageBase64=""; 
            document.getElementById('product-image-file').value = '';
            document.getElementById('submit-product-btn-text').textContent="เพิ่มสินค้าใหม่"; 
        };

        window.addCart = (id) => { 
            const product = localProducts.find(p => p.id === id);
            const category = localCategories.find(c => c.id === product.categoryId);
            
            let isSoldOut = product.isOutOfStock;
            if (category && category.isStockTracked && category.remainingStock <= 0) {
                isSoldOut = true;
            }
            
            if(isSoldOut) { 
                showModal('ของหมด'); 
                return; 
            }
            
            const item = cart.find(c => c.id === id); 
            if(item) item.quantity++; else cart.push({id, quantity:1}); 
            renderCart(); 
            showModal('เพิ่มลงตะกร้าแล้ว'); 
        };
        window.modCart = (id, val) => {
            const idx = cart.findIndex(c => c.id === id);
            if(idx === -1) return;
            if(val === 0 || cart[idx].quantity + val <= 0) cart.splice(idx, 1);
            else cart[idx].quantity += val;
            renderCart();
        };

        window.pay = async (id) => {
            const o = localOrders.find(x => x.id === id);
            if(!o) return;
            try {
                await runTransaction(db, async (t) => {
                    t.update(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: 'paid' });
                    
                    const map = new Map();
                    o.items.forEach(i => { 
                        const p = localProducts.find(x=>x.id===i.id); 
                        if(p && p.categoryId) map.set(p.categoryId, (map.get(p.categoryId)||0)+i.quantity); 
                    });
                    
                    map.forEach((qty, catId) => {
                        const category = localCategories.find(c => c.id === catId);
                        if (category && category.isStockTracked) { 
                            t.update(doc(db, `artifacts/${appId}/public/data/categories`, catId), { remainingStock: increment(-qty) });
                        }
                    });
                });
            } catch(err) { showModal('Error'); }
        };
        window.cancel = async (id) => await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: 'cancelled' });
        window.delOrder = async (id) => await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: 'deleted' }); 

        // Forms
        // (v4.3) MODIFIED: Add 'order' field on creation
        document.getElementById('add-category-form').onsubmit = async (e) => {
            e.preventDefault();
            const categoryName = document.getElementById('category-name').value;
            const isTracked = document.getElementById('category-track-stock').checked;
            
            // (v4.3) Add new categories to the end of the list
            const newOrder = localCategories.length;
            
            await addDoc(collection(db, `artifacts/${appId}/public/data/categories`), { 
                name: categoryName, 
                totalStock: 0, 
                remainingStock: 0,
                isStockTracked: isTracked,
                order: newOrder // (v4.3) New field
            }); 
            e.target.reset();
            document.getElementById('category-track-stock').checked = true; 
        };
        document.getElementById('add-product-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('product-name').value,
                basePrice: parseFloat(document.getElementById('product-price').value),
                categoryId: document.getElementById('product-category').value,
                promoType: document.getElementById('product-promo-type').value,
                updatedAt: serverTimestamp()
            };
            if(currentImageBase64) data.imageUrl = currentImageBase64;
            const id = document.getElementById('product-id').value;
            if(id) await updateDoc(doc(db, `artifacts/${appId}/public/data/products`, id), data);
            else { 
                data.isOutOfStock = false; 
                data.createdAt = serverTimestamp(); 
                // data.isRecommended = false; // (v4.6) REMOVED
                await addDoc(collection(db, `artifacts/${appId}/public/data/products`), data); 
            }
            document.getElementById('cancel-edit-btn').click();
        };

        window.editCategory = (id) => {
            const cat = localCategories.find(c => c.id === id);
            if (!cat) return;
            editCategoryId.value = id;
            editCategoryName.value = cat.name;
            editCategoryTrackStock.checked = cat.isStockTracked;
            editCategoryModal.classList.remove('hidden');
        };
        document.getElementById('edit-category-cancel').onclick = () => {
            editCategoryModal.classList.add('hidden');
        };
        editCategoryForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = editCategoryId.value;
            const name = editCategoryName.value;
            const isStockTracked = editCategoryTrackStock.checked;
            
            if (!id) return;
            
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/categories`, id), {
                    name: name,
                    isStockTracked: isStockTracked
                });
                editCategoryModal.classList.add('hidden');
                showModal("แก้ไขหมวดหมู่สำเร็จ!");
            } catch (err) {
                console.error("Error updating category: ", err);
                showModal("เกิดข้อผิดพลาด: " + err.message);
            }
        };

        window.deleteCategory = async (id) => {
            const productsInCat = localProducts.filter(p => p.categoryId === id);
            if (productsInCat.length > 0) {
                showModal(`ไม่สามารถลบได้! คุณต้องลบสินค้า ${productsInCat.length} ชิ้นในหมวดหมู่นี้ก่อน`);
                return;
            }
            
            window.showConfirmModal('คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่นี้? (ไม่สามารถย้อนกลับได้)', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/categories`, id));
                    showModal("ลบหมวดหมู่แล้ว");
                    // (v4.3) TODO: Re-order other categories? For now, snapshot will just refetch.
                } catch (err) {
                    console.error("Error deleting category: ", err);
                    showModal("เกิดข้อผิดพลาด: " + err.message);
                }
            });
        };
        
        addEatingLogForm.onsubmit = async (e) => {
            e.preventDefault();
            const categoryId = document.getElementById('eat-category-select').value;
            const quantity = parseInt(document.getElementById('eat-quantity').value);
            const person = document.getElementById('eat-person').value;
            const logId = eatLogIdInput.value;

            if (!categoryId || isNaN(quantity) || quantity <= 0 || !person) {
                showModal("ข้อมูลไม่ครบถ้วน (ต้องเลือกหมวดหมู่, จำนวน, และชื่อคนกิน)");
                return;
            }

            const category = localCategories.find(c => c.id === categoryId);
            if (!category) {
                showModal("ไม่พบหมวดหมู่");
                return;
            }

            if (category.isStockTracked && category.remainingStock < quantity) {
                showModal(`สต็อกไม่พอ! (${category.name} เหลือ ${category.remainingStock})`);
                return;
            }

            const logData = {
                categoryId: categoryId,
                categoryName: category.name,
                quantity: quantity,
                personName: person,
            };

            try {
                if (logId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/eatingHistory`, logId), logData);
                    showModal("แก้ไขบันทึกการกินสำเร็จ!");

                } else {
                    logData.createdAt = serverTimestamp();
                    const batch = writeBatch(db);
                    
                    batch.set(doc(collection(db, `artifacts/${appId}/public/data/eatingHistory`)), logData);
                    
                    if (category.isStockTracked) {
                        const stockRef = doc(db, `artifacts/${appId}/public/data/categories`, category.id);
                        batch.update(stockRef, { remainingStock: increment(-quantity) });
                    }
                    
                    await batch.commit();
                    showModal(`บันทึกการกิน (${category.name} ${quantity} ชิ้น) และตัดสต็อกสำเร็จ!`);
                }
                
                cancelEatLogBtn.click(); 

            } catch (err) {
                console.error("Error logging eating event: ", err);
                showModal("เกิดข้อผิดพลาด: " + err.message);
            }
        };

        window.editEatLog = (id) => {
            const log = localEatingHistory.find(x => x.id === id);
            eatLogIdInput.value = log.id;
            document.getElementById('eat-category-select').value = log.categoryId;
            document.getElementById('eat-quantity').value = log.quantity;
            document.getElementById('eat-person').value = log.personName;
            cancelEatLogBtn.classList.remove('hidden');
            submitEatLogBtnText.textContent = "แก้ไข";
        };

        window.delEatLog = async (id) => {
            window.showConfirmModal('ลบ? (การลบนี้จะไม่คืนสต็อกที่ตัดไปแล้ว)', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/eatingHistory`, id));
                    showModal("ลบประวัติการกินแล้ว");
                } catch (err) {
                    showModal("เกิดข้อผิดพลาด: " + err.message);
                }
            });
        };

        cancelEatLogBtn.onclick = () => {
            addEatingLogForm.reset();
            eatLogIdInput.value = '';
            cancelEatLogBtn.classList.add('hidden');
            submitEatLogBtnText.textContent = "บันทึก";
            document.getElementById('eat-quantity').value = 1; 
        };


        function renderEatingLogHistory() {
            eatingLogHistoryList.innerHTML = '';
            if (localEatingHistory.length === 0) {
                eatingLogHistoryList.innerHTML = '<p class="text-gray-500">ยังไม่มีประวัติการกิน</p>';
                return;
            }
            localEatingHistory.forEach(log => {
                eatingLogHistoryList.innerHTML += `
                    <div class="flex justify-between items-center text-sm p-2 border-b">
                        <span><strong class="text-gray-800">${log.personName}</strong> กิน ${log.categoryName} (<span class="text-red-600 font-bold">-${log.quantity}</span>)</span>
                        <div class="flex gap-2">
                            <button onclick="window.editEatLog('${log.id}')" class="text-blue-500">✎</button>
                            <button onclick="window.delEatLog('${log.id}')" class="text-red-500">x</button>
                        </div>
                    </div>`;
            });
        }


        // Expense & Report
        document.getElementById('add-expense-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = { description: document.getElementById('expense-description').value, amount: parseFloat(document.getElementById('expense-amount').value) };
            const id = document.getElementById('expense-id').value;
            if(id) await updateDoc(doc(db, `artifacts/${appId}/public/data/expenses`, id), data);
            else { data.createdAt = serverTimestamp(); data.reportStatus='pending'; await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), data); }
            document.getElementById('cancel-expense-btn').click(); 
        };
        window.editExp = (id) => { const e = localExpenses.find(x=>x.id===id); document.getElementById('expense-id').value=e.id; document.getElementById('expense-description').value=e.description; document.getElementById('expense-amount').value=e.amount; document.getElementById('cancel-expense-btn').classList.remove('hidden'); document.getElementById('submit-expense-btn-text').textContent="แก้"; };
        
        window.delExp = (id) => {
            window.showConfirmModal('ยืนยันการลบรายจ่ายนี้?', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/expenses`, id));
                    showModal('ลบรายจ่ายแล้ว');
                } catch(err) { showModal('ลบไม่สำเร็จ: ' + err.message); }
            });
        };
        
        document.getElementById('cancel-expense-btn').onclick = () => { 
            document.getElementById('add-expense-form').reset(); 
            document.getElementById('expense-id').value=''; 
            document.getElementById('cancel-expense-btn').classList.add('hidden'); 
            document.getElementById('submit-expense-btn-text').textContent="บันทึก"; 
        };
        
        function renderStockHistory() {
            stockHistoryList.innerHTML = '';
            if (localStockHistory.length === 0) {
                stockHistoryList.innerHTML = '<p class="text-gray-500">ยังไม่มีประวัติการเติม</p>';
                return;
            }
            localStockHistory.forEach(log => {
                const time = log.createdAt?.toDate ? log.createdAt.toDate().toLocaleString('th-TH') : '...';
                stockHistoryList.innerHTML += `
                    <div class="text-xs p-1 border-b">
                        <span class="font-bold">${time}</span>
                        <div>${log.categoryName}: <span class="text-green-700 font-bold">+${log.amountAdded}</span> ชิ้น</div>
                    </div>`;
            });
        }
        
        function renderStats() {
            const pendSales = localOrders.filter(o => o.status === 'paid' && o.reportStatus === 'pending').reduce((sum, o) => sum + o.totalPrice, 0);
            const pendExp = localExpenses.filter(e => e.reportStatus === 'pending').reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('sales-tally-total').textContent = pendSales.toFixed(2) + ' บ.';
            document.getElementById('expense-tally-total').textContent = pendExp.toFixed(2) + ' บ.';
            
            const histList = document.getElementById('z-report-history-list'); histList.innerHTML = '';
            localReportHistory.forEach(h => {
                const date = h.createdAt?.toDate ? h.createdAt.toDate().toLocaleString('th-TH') : '...';
                histList.innerHTML += `<div onclick="window.showHist('${h.id}')" class="p-2 border rounded hover:bg-gray-50 cursor-pointer"><div class="font-bold text-emerald-700">${date}</div><div class="text-xs">กำไร: ${h.netProfit} บ.</div></div>`;
            });
            
            const expList = document.getElementById('expense-history-list'); expList.innerHTML = '';
            localExpenses.sort((a,b)=> (b.createdAt?.toDate()||0)-(a.createdAt?.toDate()||0)).forEach(e => {
                if(e.reportStatus === 'pending') {
                    expList.innerHTML += `<div class="flex justify-between text-xs p-1 border-b"><span>${e.description}</span> <div class="flex gap-2"><span class="text-red-600">${e.amount}</span> <button onclick="window.editExp('${e.id}')" class="text-blue-500">✎</button> <button onclick="window.delExp('${e.id}')" class="text-red-500">x</button></div></div>`;
                }
            });
        }

        document.getElementById('z-report-button').onclick = () => {
            const orders = localOrders.filter(o => o.status === 'paid' && o.reportStatus === 'pending');
            const exps = localExpenses.filter(e => e.reportStatus === 'pending');
            const stockLogs = localStockHistory; 
            const eatLogs = localEatingHistory; 
            
            if(!orders.length && !exps.length && !stockLogs.length && !eatLogs.length) { 
                showModal('ไม่มียอด (ขาย, จ่าย, เติม, กิน) ที่จะสรุป'); 
                return; 
            }
            
            let sales=0, exp=0, sMap={};
            orders.forEach(o => { sales+=o.totalPrice; o.items.forEach(i => sMap[i.name]=(sMap[i.name]||0)+i.quantity); });
            exps.forEach(e => exp+=e.amount);

            document.getElementById('z-report-sales-details').innerHTML = Object.entries(sMap).map(([k,v]) => `<div>${k} x${v}</div>`).join('') || '-';
            document.getElementById('z-report-expense-details').innerHTML = exps.map(e => `<div>${e.description}: ${e.amount}</div>`).join('') || '-';
            
            document.getElementById('z-report-stock-details').innerHTML = localCategories.map(c => {
                const stockDisplay = c.isStockTracked ? `${c.remainingStock} / ${c.totalStock}` : "(ไม่นับสต็อก)";
                return `<div>${c.name}: ${stockDisplay}</div>`;
            }).join('');
            
            document.getElementById('z-report-stock-refill-details').innerHTML = 
                stockLogs.map(log => {
                    const time = log.createdAt?.toDate ? log.createdAt.toDate().toLocaleTimeString('th-TH') : '...';
                    return `<div>${time}: ${log.categoryName} (<span class="text-green-700 font-bold">+${log.amountAdded}</span>)</div>`;
                }).join('') || '-';
            
            document.getElementById('z-report-eating-log-details').innerHTML = 
                eatLogs.map(log => {
                    return `<div>${log.personName} กิน ${log.categoryName} (<span class="text-red-600 font-bold">-${log.quantity}</span>)</div>`;
                }).join('') || '-';

            
            document.getElementById('z-report-total-sales').textContent = sales.toFixed(2);
            document.getElementById('z-report-total-expense').textContent = exp.toFixed(2);
            document.getElementById('z-report-net-profit').textContent = (sales - exp).toFixed(2);
            document.getElementById('z-report-modal').classList.remove('hidden');
        };
        document.getElementById('z-report-cancel-button').onclick = () => document.getElementById('z-report-modal').classList.add('hidden');
        
        document.getElementById('z-report-confirm-button').onclick = async () => {
             const orders = localOrders.filter(o => o.status === 'paid' && o.reportStatus === 'pending');
             const exps = localExpenses.filter(e => e.reportStatus === 'pending');
             const stockLogs = localStockHistory;
             const eatLogs = localEatingHistory;
             const batch = writeBatch(db);
             
             orders.forEach(o => batch.delete(doc(db, `artifacts/${appId}/public/data/orders`, o.id)));
             exps.forEach(e => batch.update(doc(db, `artifacts/${appId}/public/data/expenses`, e.id), {reportStatus:'cleared'}));
             
             for (const cat of localCategories) {
                 if (cat.isStockTracked) { 
                     batch.update(doc(db, `artifacts/${appId}/public/data/categories`, cat.id), {
                         totalStock: cat.remainingStock 
                     });
                 }
             }
             
             stockLogs.forEach(docSnap => {
                batch.delete(doc(db, `artifacts/${appId}/public/data/stockHistory`, docSnap.id));
             });

             eatLogs.forEach(docSnap => {
                batch.delete(doc(db, `artifacts/${appId}/public/data/eatingHistory`, docSnap.id));
             });

             const salesSummary = orders.flatMap(o => o.items).reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + item.quantity; return acc;
             }, {});
             const expenseSummary = exps.map(e => ({description:e.description, amount:e.amount}));
             const stockSnapshot = localCategories.map(c => ({
                 name: c.name, 
                 remainingStock: c.remainingStock, 
                 totalStock: c.totalStock,
                 isStockTracked: c.isStockTracked 
             }));
             const stockRefillSnapshot = stockLogs.map(log => ({
                 categoryName: log.categoryName,
                 amountAdded: log.amountAdded
             }));
             const eatingLogSnapshot = eatLogs.map(log => ({
                 personName: log.personName,
                 categoryName: log.categoryName,
                 quantity: log.quantity
             }));
             
             const salesStr = document.getElementById('z-report-total-sales').textContent;
             const expStr = document.getElementById('z-report-total-expense').textContent;
             const netStr = document.getElementById('z-report-net-profit').textContent;

             await addDoc(collection(db, `artifacts/${appId}/public/data/zReportHistory`), {
                 createdAt: serverTimestamp(), 
                 totalSales: parseFloat(salesStr), 
                 totalExpenses: parseFloat(expStr), 
                 netProfit: parseFloat(netStr),
                 salesSummary: Object.entries(salesSummary).map(([name, quantity]) => ({name, quantity})),
                 expenseSummary: expenseSummary,
                 stockSnapshot: stockSnapshot, 
                 stockRefillSnapshot: stockRefillSnapshot,
                 eatingLogSnapshot: eatingLogSnapshot
             });
             
             await batch.commit(); 
             document.getElementById('z-report-modal').classList.add('hidden'); 
             showModal('ตัดยอดสำเร็จ! (ลบออเดอร์เก่า, รีเซ็ตสต็อก, ล้างประวัติ เติม/กิน)');
        };

        window.showHist = (id) => {
            const h = localReportHistory.find(x => x.id === id);
            
            const stockRefillsHtml = h.stockRefillSnapshot && h.stockRefillSnapshot.length > 0
                ? `<div class="font-bold text-yellow-700 mt-2">ประวัติเติมสต็อก (ที่ถูกล้าง)</div><div class="ml-2 text-sm">${h.stockRefillSnapshot.map(s=>`<div>${s.categoryName}: +${s.amountAdded}</div>`).join('')}</div>`
                : '';
            
            const eatingLogsHtml = h.eatingLogSnapshot && h.eatingLogSnapshot.length > 0
                ? `<div class="font-bold text-orange-700 mt-2">ประวัติการกิน (ที่ถูกล้าง)</div><div class="ml-2 text-sm">${h.eatingLogSnapshot.map(s=>`<div>${s.personName} กิน ${s.categoryName} (-${s.quantity})</div>`).join('')}</div>`
                : '';
            
            const stockSnapshotHtml = h.stockSnapshot && h.stockSnapshot.length > 0
                ? `<div class="font-bold text-blue-700 mt-2">สต็อก (ณ เวลาตัดยอด)</div><div class="ml-2 text-sm">${h.stockSnapshot.map(s => {
                    const stockDisp = s.isStockTracked ? `${s.remainingStock}/${s.totalStock}` : "(ไม่นับสต็อก)";
                    return `<div>${s.name}: ${stockDisp}</div>`;
                }).join('')}</div>`
                : '';


            document.getElementById('history-detail-content').innerHTML = `
                <div class="font-bold mb-2 text-emerald-800">${h.createdAt?.toDate().toLocaleString('th-TH')}</div>
                <div class="font-bold text-green-700 mt-2">รายรับ (${h.totalSales} บ.)</div><div class="ml-2 text-sm">${h.salesSummary.map(s=>`<div>${s.name} x${s.quantity}</div>`).join('')}</div>
                <div class="font-bold text-red-700 mt-2">รายจ่าย (${h.totalExpenses} บ.)</div><div class="ml-2 text-sm">${h.expenseSummary.map(e=>`<div>${e.description}: ${e.amount}</div>`).join('')}</div>
                ${stockSnapshotHtml}
                ${stockRefillsHtml}
                ${eatingLogsHtml}
                <div class="font-bold text-blue-800 mt-4 text-xl border-t pt-2">กำไรสุทธิ: ${h.netProfit} บ.</div>
            `;
            
            document.getElementById('history-detail-modal').classList.remove('hidden');
        };
        document.getElementById('history-detail-close-btn').onclick = () => document.getElementById('history-detail-modal').classList.add('hidden');

        // Init
        document.getElementById('admin-search-bar').oninput = renderProducts;
        document.getElementById('customer-search-bar').oninput = renderProducts;

        showStoreBtn.onclick = () => { 
            storeSection.classList.remove('hidden'); 
            adminSection.classList.add('hidden'); 
            showStoreBtn.classList.add('bg-white', 'text-emerald-700');
            showStoreBtn.classList.remove('bg-emerald-800', 'text-white');
            showAdminBtn.classList.add('bg-emerald-800', 'text-white');
            showAdminBtn.classList.remove('bg-white', 'text-emerald-700');
        };
        showAdminBtn.onclick = () => { 
            adminSection.classList.remove('hidden'); 
            storeSection.classList.add('hidden'); 
            showAdminBtn.classList.add('bg-white', 'text-emerald-700');
            showAdminBtn.classList.remove('bg-emerald-800', 'text-white');
            showStoreBtn.classList.add('bg-emerald-800', 'text-white');
            showStoreBtn.classList.remove('bg-white', 'text-emerald-700');
        };
        
        document.getElementById('admin-login-btn').onclick = () => document.getElementById('admin-login-modal').classList.remove('hidden');
        document.getElementById('admin-login-modal-close').onclick = () => document.getElementById('admin-login-modal').classList.add('hidden');

        document.getElementById('admin-login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                document.getElementById('admin-login-modal').classList.add('hidden');
                showModal('ล็อกอินแอดมินสำเร็จ!');
            } catch (err) {
                showModal('ล็อกอินผิดพลาด: ' + err.message);
            }
        };

        document.getElementById('admin-logout-btn').onclick = async () => {
            try {
                await signOut(auth);
            } catch (err) {
                showModal('ล็อกเอาต์ผิดพลาด: ' + err.message);
            }
        };
        
        document.getElementById('show-clear-history-modal').onclick = () => {
            confirmClearModal.classList.remove('hidden');
        };
        document.getElementById('confirm-clear-cancel').onclick = () => {
            confirmClearModal.classList.add('hidden');
        };
        document.getElementById('confirm-clear-confirm').onclick = async () => {
            await clearAllHistory();
            confirmClearModal.classList.add('hidden');
        };
        
        async function clearAllHistory() {
            showModal("กำลังล้างประวัติทั้งหมด...");
            try {
                const batch = writeBatch(db);
                
                localReportHistory.forEach(docSnap => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/zReportHistory`, docSnap.id));
                });
                
                localStockHistory.forEach(docSnap => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/stockHistory`, docSnap.id));
                });
                
                const clearedExpenses = localExpenses.filter(e => e.reportStatus === 'cleared');
                clearedExpenses.forEach(docSnap => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/expenses`, docSnap.id));
                });
                
                localEatingHistory.forEach(docSnap => {
                    batch.delete(doc(db, `artifacts/${appId}/public/data/eatingHistory`, docSnap.id));
                });

                await batch.commit();
                showModal("ล้างประวัติ (ตัดยอด, สต็อก, รายจ่าย, การกิน) สำเร็จ!");
            } catch (err) {
                console.error("Error clearing history: ", err);
                showModal("เกิดข้อผิดพลาด: " + err.message);
            }
        }


        function setupAuthListener() {
            setLogLevel('debug'); 
            db = getFirestore(app); 
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('app-id-display').textContent = appId; 
                    document.getElementById('user-id-display').textContent = userId;

                    if (user.isAnonymous) {
                        document.getElementById('auth-status').textContent = 'Customer (Anonymous)';
                        document.getElementById('show-admin-btn').classList.add('hidden'); 
                        document.getElementById('admin-login-btn').classList.remove('hidden'); 
                        document.getElementById('admin-logout-btn').classList.add('hidden'); 
                        showStoreBtn.click(); 
                    } else {
                        document.getElementById('auth-status').textContent = 'ADMIN';
                        document.getElementById('show-admin-btn').classList.remove('hidden'); 
                        document.getElementById('admin-login-btn').classList.add('hidden'); 
                        document.getElementById('admin-logout-btn').classList.remove('hidden'); 
                    }

                    if (!listenersInitialized) {
                        setupDataListeners();
                        listenersInitialized = true;
                    }
                    
                } else {
                    document.getElementById('auth-status').textContent = 'Signing in...';
                    signInAnonymously(auth).catch(err => {
                        console.error("Anonymous sign-in failed: ", err);
                        showModal("การเชื่อมต่อล้มเหลว (Anonymous Auth Error)");
                    });
                }
            });
        }
        
        function setupDataListeners() {
            const paths = [
                `artifacts/${appId}/public/data/categories`, 
                `artifacts/${appId}/public/data/products`, 
                `artifacts/${appId}/public/data/orders`, 
                `artifacts/${appId}/public/data/expenses`, 
                `artifacts/${appId}/public/data/zReportHistory`,
                `artifacts/${appId}/public/data/stockHistory`,
                `artifacts/${appId}/public/data/eatingHistory`
            ];
            
            // (v4.5) FIX: Removed orderBy("order") from query to fetch all categories (even old ones without 'order' field).
            // Sorting is now handled reliably in renderCategories().
            onSnapshot(query(collection(db, paths[0])), s => { localCategories = s.docs.map(d=>({id:d.id,...d.data()})); renderCategories(); renderProducts(); });
            
            onSnapshot(query(collection(db, paths[1])), s => { localProducts = s.docs.map(d=>({id:d.id,...d.data()})); renderProducts(); renderCart(); });
            onSnapshot(query(collection(db, paths[2]), orderBy("createdAt", "desc")), s => { localOrders = s.docs.map(d=>({id:d.id,...d.data()})); renderOrders(); renderStats(); });
            onSnapshot(query(collection(db, paths[3])), s => { localExpenses = s.docs.map(d=>({id:d.id,...d.data()})); renderStats(); });
            onSnapshot(query(collection(db, paths[4]), orderBy("createdAt", "desc")), s => { localReportHistory = s.docs.map(d=>({id:d.id,...d.data()})); renderStats(); });
            onSnapshot(query(collection(db, paths[5]), orderBy("createdAt", "desc")), s => { 
                localStockHistory = s.docs.map(d=>({id:d.id,...d.data()})); 
                renderStockHistory(); 
            });
            onSnapshot(query(collection(db, paths[6]), orderBy("createdAt", "desc")), s => { 
                localEatingHistory = s.docs.map(d=>({id:d.id,...d.data()})); 
                renderEatingLogHistory(); 
            });
        }

        setupAuthListener();

    </script>
</body>
</html>
